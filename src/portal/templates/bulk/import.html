{% extends "common/base.html" %}

{% load i18n static %}
{% load bootstrap4 %}

{% block title %}
一括登録
{% endblock title %}

{% block breadcrumbtitle %}

<nav aria-label="breadcrumb">
  <ol class="breadcrumb mb-1">
      <li class="breadcrumb-item"><a href="{% url 'accounts:home' %}">ホーム</a></li>
      <li class="breadcrumb-item">ユーザー管理</li>
      <li class="breadcrumb-item active">一括登録</li>
  </ol>
</nav>
 
{% endblock breadcrumbtitle %}

{% block extra_css %}
{% endblock %}

{% block content %}
{% comment %} <div class="container bulk"> {% endcomment %}
  <div class="card border-0 mt-1">
    <h5 class="bulk-guide"><i class="fas fa-mouse-pointer"></i>&nbsp;操作方法</h5>
    <h6 class="pt-2">
      １．一括登録に必要なcsv形式のファイル(ファイル名：template.csv)を、<a href="{% url 'bulk:template' %}" style="background:#ffc4a6; color:#000;">ここをクリック</a>してダウンロードしてください。<br />
      ２．ダウンロードしたファイルに追加したいユーザー情報を入力してください。<br />
      ３．作成したcsvファイルを以下の領域にドラッグ＆ドロップして、「確認」をクリックしてください。
    </h6>
    <br>
    <div id="myAwesomeDropzone" class="dropzone">
      <div class="fallback"> <!-- this is the fallback if JS isn't working -->
        <input name="file" type="file" />
      </div><!--fallback-->
    </div><!--dropzone-->
    <br>
    <!-- ドラッグアンドドロップ後に表示されるプレビューを読み込み -->
    {% include 'bulk/preview.html' %}
  </div><!--card-->
{% comment %} </div><!--container--> {% endcomment %}
<h5 class="error_msg text-danger ml-2 invisible">以下のメールアドレスはすでに登録済みのユーザーと重複しています。入力しなおしてください。</h5>
<div class="error_list"></div>

<!-- 確認ボタン -->
<div class="btn-toolbar fixed-bottom p-3 align-middle">  
  <div class="row mx-auto">
    <h5 class="align-middle d-block m-2 tool-text">確認ボタンを押してデータ確認後、登録ボタンが表示されます。</h5>
    <button type="button" class="btn my-btn-w11 mr-3 my-btn-cancel cancel" onclick="location.href='{% url 'accounts:user' %}'">キャンセル</button>
    <button type="button" id="dataCheck" class="btn my-btn-w11 bar_button_r mr-1 my-btn-accept check" disabled>確認&nbsp;</button>
  </div><!--row-->
</div><!--btn-toolbar-->

<!-- 確認から登録 -->
<div class="modal fade" id="importModal" data-backdrop="static" data-keyboard="false"  tabindex="-1" aria-labelledby="importModalLabel">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">

      </div>
      <div class="modal-footer">
        <button type="button" id="import_modal_btn" class="btn btn-sm my-btn-w8 my-btn-accept">登録</button>
        <button type="button" id="import_cancel_btn" class="btn btn-sm my-btn-w8 my-btn-cancel" data-dismiss="modal">キャンセル</button>
      </div><!-- /.modal-footer -->
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- 登録ボタン押下後 -->
<div class="modal fade" id="importedModal" tabindex="-1" aria-labelledby="importedModalLabel">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm my-btn-w8 my-btn-cancel" data-dismiss="modal">閉じる</button>
      </div><!-- /.modal-footer -->
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

 <!-- レスポンス用トースト -->
<div class="position-fixed p-3" style="z-index: 2000; right: 0; bottom: 0;">
  <div id="result_toast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-body">
          <div>
              
          </div>
      </div>
  </div>
</div>

<!-- 2つ以上のファイルをアップロードした際の置換え確認用モーダルを読み込む -->
{% include 'bulk/remove_modal.html' %}

{% endblock %}

{% block extra_js %}

<script>

  // -----------------
  // Dropzone.jsの設定
  // -----------------

  // Dropzoneの自動検出を無効
  Dropzone.autoDiscover = false;

  // Get the template HTML and remove it from the doumenthe template HTML and remove it from the document
  var previewNode = document.querySelector("#template");
  // #templateというIDがあるときのみ処理
  if (previewNode) {
    previewNode.id = "";
    var previewTemplate = previewNode.parentNode.innerHTML;
    previewNode.parentNode.removeChild(previewNode);
  }


$(function() {
    $("div#myAwesomeDropzone").dropzone({
      url: "{% url 'bulk:test_import' %}",
      params: {'csrfmiddlewaretoken': getCookie('csrftoken')},
      autoProcessQueue: false,
      maxFiles: 1,
      maxFilesize: 0.5, // MiB
      acceptedFiles: ".csv, text/csv",
      paramName: "file",
      dictDefaultMessage: '<span class="dropzone_text">作成したcsvファイルをここにドラッグ&ドロップしてください</span><br /><br /><i class="fas fa-file-upload fa-5x dropzone_upload_icon"></i><br /><br />ファイルを選択',
      previewTemplate: previewTemplate,
      previewsContainer: "#previews",

      // The setting up of the dropzone
      init: function() {
        var myDropzone = this;
        // ドラッグ&ドロップ領域以外にファイルをドラッグ&ドロップしても反応しないようにする
        $(document).on('drop dragover', function (e) {
          e.stopPropagation();
          e.preventDefault();
        });

        //ファイルを追加したときに確認ボタンを有効化する
        myDropzone.on("addedfile", function(file) {
          $("#dataCheck").prop('disabled',false);
        });
        //ファイルを削除したときに確認ボタンを無効化する
        myDropzone.on("removedfile", function(file) {
          $("#dataCheck").prop('disabled',true);
        });

        //確認ボタンを押下し、内容チェック
        $("#dataCheck").click(function (e) {
          //エラーリストを初期化
          if($('#e_list').length){
            $('#e_list').remove();
          };
          myDropzone.on("processing", function (file) {
            myDropzone.options.url = "{% url 'bulk:test_import' %}"
          });

          e.preventDefault();
          myDropzone.processQueue();
        });

        // Update the total progress bar
        myDropzone.on("totaluploadprogress", function(progress) {
          $(".progress-bar").css("width" , progress + "%");
          $(".progress-text").text = progress + "%";
        });
        
      },
      maxfilesexceeded:  function(file) {
        // thisオブジェクトが変わるため、変数に格納しておく
        var myDropzone = this;
        // モーダルを表示する
        $('#removeModal').modal('show');
        // 置き換えるボタンがクリックされた場合
        $("#removeModalButton").click(function (e) {
          // モーダルを非表示
          $('#removeModal').modal('hide');
            // 旧ファイルを削除して新しいファイルを追加する(置き換える)
            myDropzone.removeAllFiles();
            myDropzone.addFile(file);
        });
      },

      // アップロードが成功またはエラーが発生したときファイルを削除する。
      complete: function(file, respnese){
        this.removeFile(file);
      },
      // 確認成功時にメッセージを表示。
      success: function(self, response){
        $('#importModal').on('show.bs.modal', function (e) {
          var modal = $(this).find('.modal-body');

          modal.html('<h6>' + response["messages"] + '</h6>');
        });
        //データ照合成功
        if(response["judge"] == 'SUCCESS'){
          $('import_modal_btn').prop('hidden',false);
          //重複エラー時の表示を隠す
          $(".error_msg").addClass("invisible");
          $('.error_list').addClass("invisible");
          var file_name = response["file_name"]//ランダムな文字列
          var random_file = './' + file_name

          $('#importModal').modal('show');
          //登録ボタンを押下した場合、Ajaxで送信
          $('#import_modal_btn').on('click', function() {
            $('#importModal').modal('hide');
            $.ajax({
              type: "POST",
              url: '/ajax_import/',
              data: {
                'random_file': random_file
              },
              dataType: 'json'
              //一括登録成功時
            }).done(function (data) {
              //$('#importedModal').on('show.bs.modal', function (e) {
                //var modal = $('#importedModal').find('.modal-body');
                //modal.html('<h6>' + data["messages2"] + '</h6>');
              //});
              //$('#importedModal').modal('show');
              $('#result_toast').on('show.bs.toast', function (e) {
                var toast = $(this);
                toast.find('.toast-body').addClass('alert-success');//このクラスを付与して成功時の色を定義
                toast.find('.toast-body').text(data["messages2"]);//サーバ側から戻ってきたメッセージを表示
              });
              $('#result_toast').toast({ delay: 5000, animation: true }).toast('show'); //表示処理 
              //一括登録失敗時
            }).fail(function (data){
              //$('#importedModal').on('show.bs.modal', function (e) {
                //var modal = $('#importedModal').find('.modal-body');
                //modal.html('<h6>' + data["messages2"] + '</h6>');
              //});
              //$('#importedModal').modal('show');
              $('#result_toast').on('show.bs.toast', function (e) {
                var toast = $(this);
                toast.find('.toast-body').addClass('alert-danger');//このクラスを付与して成功時の色を定義
                toast.find('.toast-body').text(data["messages2"]);//サーバ側から戻ってきたメッセージを表示
              });
              $('#result_toast').toast({ delay: 5000, animation: true }).toast('show'); //表示処理 

            });
          });
          //キャンセルボタンで仮ファイル削除
          $('#import_cancel_btn').on('click',function(){
            $.ajax({
              type: "POST",
              url: '/file_delete/',
              data: {
                'random_file': random_file
              },
              dataType: 'json'
            }).done(function(data){
              //$('#importedModal').on('show.bs.modal', function (e) {
                //var modal = $('#importedModal').find('.modal-body');
                //modal.html('<h6>' + data["messages3"] + '</h6>');
              //});
              $('#result_toast').on('show.bs.toast', function (e) {
                var toast = $(this);
                toast.find('.toast-body').addClass('alert-success');//このクラスを付与して成功時の色を定義
                toast.find('.toast-body').text(data["messages3"]);//サーバ側から戻ってきたメッセージを表示
              });
              $('#result_toast').toast({ delay: 5000, animation: true }).toast('show'); //表示処理 
              //$('#importedModal').modal('show');
            }).fail(function(data){
              //$('#importedModal').on('show.bs.modal', function (e) {
                //var modal = $('#importedModal').find('.modal-body');
                //modal.html('<h6>' + data["messages3"] + '</h6>');
              //});
              //$('#importedModal').modal('show');
              $('#result_toast').on('show.bs.toast', function (e) {
                var toast = $(this);
                toast.find('.toast-body').addClass('alert-danger');//このクラスを付与して成功時の色を定義
                toast.find('.toast-body').text(data["messages3"]);//サーバ側から戻ってきたメッセージを表示
              });
              $('#result_toast').toast({ delay: 5000, animation: true }).toast('show'); //表示処理
            });
          });

        //データ重複エラー
        }else{
          $('#import_modal_btn').prop('hidden',true);
          $(".error_msg").removeClass("invisible");
          //エラーのアドレスを表示
          for(var i=0; i<$(response['error_list']).length;){
            $('.error_list').append('<h5 class="ml-2" id="e_list">' + response['error_list'][i] + '</h5>');
            i++;
          };
          //toast化
          $('#result_toast').on('show.bs.toast', function (e) {
            var toast = $(this);
            toast.find('.toast-body').addClass('alert-danger');//このクラスを付与して表示色定義
            toast.find('.toast-body').text(response["messages"]);//サーバ側から戻ってきたメッセージを表示
          });
          $('#result_toast').toast({ delay: 5000, animation: true }).toast('show'); //表示処理
          $('#import_modal_btn').prop('hidden',false);
          //$('#importModal').modal('show');
          //$('#import_cancel_btn').on('click',function(){
            //$('#import_modal_btn').prop('hidden',false);
          //});
        };
      },
      // アップロード失敗時にメッセージを表示する。
      error: function(file, response, xhr){
        // フロントエンドでエラーが発生した場合。(サーバからのレスポンスがないエラー)
        var modal = $('#importModal').find('.modal-body');
        $('#importModal').on('show.bs.modal', function (e) {
          /*if (xhr == null) {
            // 2つ以上のファイルアップロードの場合
            if (response == "You can not upload any more files.") {
            // エラーを表示しない
            } else if (response == "You can't upload files of this type.") {
              modal.html('<h6>' + gettext("UPLOAD CSV FILE") + '</h6>');
            } else if (!response.indexOf("File is too big")) {
              modal.html('<h6>' + "ファイルサイズ上限(0.5MB)を超えています。サイズを小さくしてください。" + '</h6>');
            } else {
              modal.html('<h6>' + response + '</h6>');
            }
        // サーバーからレスポンスが帰ってきた場合(サーバ側でエラーが発生した場合)
          } else {
            //var modal = $(this).find('.modal-body');
            modal.html('<h6>' + response["messages"] + '</h6>');
          }*/
          modal.html('<h6>' + response["messages"] + '</h6>');
          $(".error_msg").addClass("invisible");
          $('.error_list').addClass("invisible");
          $('#import_modal_btn').prop('hidden',true);
        });
        $('#importModal').modal('show');
      },
    });
});

</script>

{% endblock %}