{% extends "common/base.html" %}

{% load i18n static %}
{% load widget_tweaks %}
{% load humanize %}
{% load is_exist %}
{% block title %}見積書作成 - プランの選択{% endblock title %}


{% block breadcrumbtitle %}

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-1">
            <li class="breadcrumb-item"><a href="{% url 'accounts:home' %}">ホーム</a></li>
            <li class="breadcrumb-item">契約管理</li>
            <li class="breadcrumb-item"><a href="{% url 'contracts:estimate' %}">見積一覧</a></li>
            <li class="breadcrumb-item active">見積書作成 ― プランの選択</li>
        </ol>
    </nav>

{% endblock breadcrumbtitle %}


{% block content %}

    <ul class="progressbar pt-4">
        <li class="complete">サービスの選択</li>
        <li class="active">プランの選択</li>
        <li>支払い方法の選択</li>
        <li>見積書の確認</li>
    </ul>


    <!-- フォーム -->
    <div class="card border-0 mx-auto mt-5">
        <h5 class="estimate-guide"><i class="fas fa-feather"></i>&nbsp;作成の流れ</h5>
        <h6 class="pt-2 py-3">
            １．ご希望のプランとオプションを選択してください。<br>
            ２．見積りの内容をご確認後、「次へ」を押してください。<br>
            <button type="button" class="btn my-btn-w9 mt-2 my-btn-accept" data-toggle="modal" data-target="#exampleModal">プラン比較表</button>
            <button type="button" class="btn my-btn-w12 mt-2 my-btn-accept" data-toggle="modal" data-target="#exampleModal2">オプション比較表</button>
        </h6>
        <!-- Form全体のバリデーション時のエラーを表示 -->
        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}

        <!-- <div class="page-title">プランの選択</div> -->
        <div class="card-body p-0">

            <form action="" method="post" data-validate>{% csrf_token %}
                <div class="row mx-auto pb-5 ">
                    <div class="col-6 mb-5 pl-0">
                        <table class="table table-bordered">
                            <tbody>
                                <tr>
                                    <th class="tr_head estimate_tr_head">
                                        <div class="required_box">
                                            <div class="label require_label">プラン</div>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="">
                                            <!-- 入力フィールド -->
                                            {% if form.is_bound %}

                                                {% if form.plan.errors %}
                                                    {% render_field form.plan class="form-control is-invalid" %}
                                                    {% for error in form.plan.errors %}
                                                        <div class="invalid-feedback">
                                                            {{ error }}
                                                        </div>
                                                    {% endfor %}

                                                {% else %}
                                                    {% render_field form.plan class="form-control is-valid" %}
                                                {% endif %}

                                            {% else %}<!-- 初期表示 -->
                                                {% render_field form.plan class="form-control" %}
                                            {% endif %}
                                        </div>
                                    </th>
                                </tr>

                                <tr>
                                    <th class="tr_head estimate_tr_head">
                                        <div class="option_box">
                                            <div class="label option_label">オプション</div>
                                        </div>
                                    </th>
                                    <th>
                                        {% if options_list|is_exist:form.option1.name %}
                                            <!-- オプション1 -->
                                            <div class="">
                                                <!-- 入力フィールド -->
                                                {% if form.is_bound %}

                                                    {% if form.option1.errors %}
                                                        {% render_field form.option1 class="form-control is-invalid" %}
                                                        {% for error in form.option1.errors %}
                                                            <div class="invalid-feedback">
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        {% render_field form.option1 class="form-control is-valid" %}
                                                    {% endif %}
                                                {% else %}<!-- 初期表示 -->
                                                    {% render_field form.option1  class="form-control" %}
                                                {% endif %}
                                            </div>
                                        {% endif %}

                                        {% if options_list|is_exist:form.option2.name %}
                                            <hr>
                                            <!-- オプション2 -->
                                            <div class="">
                                                <!-- 入力フィールド -->
                                                {% if form.is_bound %}

                                                    {% if form.option2.errors %}
                                                        {% render_field form.option2 class="form-control is-invalid" %}
                                                        {% for error in form.option2.errors %}
                                                            <div class="invalid-feedback">
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        {% render_field form.option2 class="form-control is-valid" %}
                                                    {% endif %}
                                                {% else %}<!-- 初期表示 -->
                                                    {% render_field form.option2 class="form-control" %}
                                                {% endif %}
                                            </div>
                                        {% endif %}

                                        {% if options_list|is_exist:form.option3.name %}
                                            <hr>
                                            <!-- オプション3 -->
                                            <div class="">
                                                <!-- 入力フィールド -->
                                                {% if form.is_bound %}
                                                    {% if form.option3.errors %}
                                                        {% render_field form.option3 class="form-control is-invalid" %}
                                                            {% for error in form.option3.errors %}
                                                                <div class="invalid-feedback">
                                                                    {{ error }}
                                                                </div>
                                                            {% endfor %}
                                                    {% else %}
                                                        {% render_field form.option3 class="form-control is-valid" %}
                                                    {% endif %}
                                                {% else %}<!-- 初期表示 -->
                                                    {% render_field form.option3 class="form-control" %}
                                                {% endif %}
                                            </div>
                                        {% endif %}

                                        {% if options_list|is_exist:form.option4.name %}
                                            <hr>
                                            <!-- オプション4 -->
                                            <div class="">
                                                <!-- 入力フィールド -->
                                                {% if form.is_bound %}
                                                    {% if form.option4.errors %}
                                                        {% render_field form.option4 class="form-control is-invalid" %}
                                                        {% for error in form.option4.errors %}
                                                            <div class="invalid-feedback">
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        {% render_field form.option4 class="form-control is-valid" %}
                                                    {% endif %}
                                                {% else %}<!-- 初期表示 -->
                                                    {% render_field form.option4 class="form-control" %}
                                                {% endif %}
                                            </div>
                                        {% endif %}

                                        {% if options_list|is_exist:form.option5.name %}
                                            <hr>
                                            <!-- オプション5 -->
                                            <div class="">
                                                <!-- 入力フィールド -->
                                                {% if form.is_bound %}
                                                    {% if form.option5.errors %}
                                                        {% render_field form.option5 class="form-control is-invalid" %}
                                                        {% for error in form.option5.errors %}
                                                            <div class="invalid-feedback">
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        {% render_field form.option5 class="form-control is-valid" %}
                                                    {% endif %}
                                                {% else %}<!-- 初期表示 -->
                                                    {% render_field form.option5 class="form-control" %}
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </th>
                                </tr>
                            </tbody>
                        </table>
                    </div><!--col6-->

                    <div class="col-6 mb-5 py-3 estimate-preview">

                        <div class='row'>
                            <div class='col'>
                            </div>
                            <div class='col text-center'>
                                <h6 class="font-weight-bold">見積プレビュー</h6>
                            </div><!--colsm-->
                            <div class='col'>
                            </div>
                        </div><!--row-->
                        <hr class="mt-0">

                        <div class='row mt-3'>
                            <div class='col'>
                                <h6 class="font-weight-bold">サービス</h6>
                            </div><!--colsm-->
                            <div class='col'>
                                <h6 id="service_name">{{ service.name }}</h6>
                            </div><!--colsm-->
                            <div class='col'>
                            </div><!--colsm-->
                        </div><!--row-->

                        <div class='row mt-2'>
                            <div class='col'>
                                <h6 class="font-weight-bold">サービス契約開始日</h6>
                            </div><!--colsm-->
                            <div class='col'>
                                <h6>{{ estimate.start_day|date:'Y年m月d日' }}</h6>
                            </div><!--colsm-->
                            <div class='col'>
                            </div><!--colsm-->
                        </div><!--row-->

                        <div class='row mt-2'>
                            <div class='col'>
                                <h6 class="font-weight-bold">プラン</h6>
                            </div><!--colsm-->
                            <div class='col'>
                                <h6 id="s_plan"></h6>
                            </div><!--colsm-->
                            <div class='col pr-4 text-right'>
                                <h6 id="p_price"></h6>
                            </div><!--colsm-->
                        </div><!--row-->

                        <div class='row mt-2' style="height:140px;">
                            <div class='col'>
                                <h6 class="font-weight-bold">オプション</h6>
                            </div><!--colsm-->
                            <div class='col' id="s_option">
                            </div><!--colsm-->
                            <div class='col pr-4 text-right' id="o_price">
                            </div><!--colsm-->
                        </div><!--row-->
                        {% if estimate.method_payment.id == 1 and estimate.discount %}
                            <div class='row mt-2' style="height:50px;">
                                <div class='col'>
                                    <h6 class="font-weight-bold">割引</h6>
                                </div><!--colsm-->
                                <div class='col discount-name'>
                                    <h6 class="credit-discount">クレジットカード支払割引</h6>
                                    <h6 class="dis-name text-right">-{{ estimate.discount.name }}</h6>
                                </div><!--colsm-->
                                <div class="col discount-price pr-4">
                                    <h6 class=' text-right credit-discount'>-{{ estimate.method_payment.payment_discount|intcomma }}</h6>
                                    <h6 class="dis-price text-right" data-disprice="{{estimate.discount.discount_rate}}">-{{ estimate.discount.discount_rate|intcomma }}</h6>
                                </div>
                            </div>
                        {% elif estimate.method_payment.id == 1 %}
                            <div class='row mt-2' style="height:50px;">
                                <div class='col'>
                                    <h6 class="font-weight-bold">割引</h6>
                                </div><!--colsm-->
                                <div class='col discount-name'>
                                    <h6 class="credit-discount">クレジットカード支払割引</h6>
                                </div><!--colsm-->
                                <div class="col discount-price pr-4">
                                    <h6 class=' text-right credit-discount'>-{{ estimate.method_payment.payment_discount|intcomma }}</h6>
                                </div>
                            </div>
                        {% elif estimate.discount %}
                            <div class='row mt-2' style="height:50px;">
                                <div class='col'>
                                    <h6 class="font-weight-bold">割引</h6>
                                </div><!--colsm-->
                                <div class='col discount-name'>
                                    <h6 class="dis-name text-right">-{{ estimate.discount.name }}</h6>
                                </div><!--colsm-->
                                <div class="col discount-price pr-4">
                                    <h6 class="dis-price text-right" data-disprice="{{estimate.discount.discount_rate}}">-{{ estimate.discount.discount_rate|intcomma }}</h6>
                                </div>
                            </div>
                        {% else %}
                            <div class='row mt-2' style="height:50px;"></div>
                        {% endif %}

                        <hr class="hr-dark">

                        <div class='row'>
                            <div class='col'>
                            </div><!--colsm-->
                            <div class='col text-right'>
                                <h5 class="font-weight-bold">合計(税抜)</h5>
                            </div><!--colsm-->
                            <div class='col pr-4 text-right'>
                                {% if estimate.unit_total %}
                                    <h5 id="total_price" class="font-weight-bold" data-total="{{estimate.unit_total}}">
                                        {{ estimate.unit_total|intcomma }}/年
                                {% else %}
                                    <h5 id="total_price" class="font-weight-bold">
                                        0
                                {% endif %}
                                </h5>
                            </div><!--colsm-->
                        </div><!--row-->

                        <div class='mt-2 text-right'>
                            <h6 class="pr-2">単位：円</h6>
                        </div>
                    </div><!--col6-->
                </div><!--row-->

                <div class="btn-toolbar fixed-bottom p-3">  
                    <div class="row mx-auto">
                        <button type="button" class="btn my-btn-w11 ml-1 my-btn-cancel cancel mr-5" data-toggle="modal" data-target="#cancel_modal" onfocus="this.blur();">キャンセル</button>
                        <h5 class="align-middle d-block m-2 tool-text">必須項目を入力して次へ進んでください。</h5>
                        <button type="button" class="btn my-btn-w11 mr-2 my-btn-accept text-center" onclick="location.href='{% url 'contracts:estimate_return' %}'"><span class="return2"></span>戻る</button>
                        <button type="submit" class="btn my-btn-w11 ml-2 my-btn-accept text-center">次へ<span class="next"></span></button>
                    </div>
                </div>
            </form>
        </div><!--card-body-->
    </div><!--card-->

    <!-- モーダルの設定 -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">プラン比較表</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="閉じる">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div><!--modal-header-->
                <div class="modal-body">
                    <h5 class="pl-3">さらに詳しいサービス紹介サイトは<a href="{% url 'accounts:help' %}" target="_blank">こちら</a>！</h5>
                    <div class="container-fluid">
                        <div class="row mx-auto">
                            <div class="col-4 p-0">
                                <div class="text-center m-1 border-yellow">
                                    <h4 class="bg-yellow py-3 text-white">ライトプラン</h4>
                                    <h5 class="plan-price1"></h5>
                                    <h5 class="text-secondary">利用可能人数：<span class="text-dark">100人</span></h5>
                                    <h5 class="text-secondary">コンテンツ保存可能数：<span class="text-dark">50</span></h5>
                                </div><!--border-->
                            </div><!--ライトプラン-->
                            <div class="col-4 p-0">
                                <div class="text-center m-1 border-blue">
                                    <h4 class="bg-blue py-3 text-white">ベーシックプラン</h4>
                                    <h5 class="plan-price2"></h5>
                                    <h5 class="text-secondary">利用可能人数：<span class="text-dark">300人</span></h5>
                                    <h5 class="text-secondary">コンテンツ保存可能数：<span class="text-dark">100</span></h5>
                                </div><!--border-->
                            </div><!--ベーシックプラン-->
                            <div class="col-4 p-0">
                                <div class="text-center m-1 border-red">
                                    <h4 class="bg-red py-3 text-white">プレミアムプラン</h4>
                                    <h5 class="plan-price3"></h5>
                                    <h5 class="text-secondary">利用可能人数：<span class="text-dark">無制限</span></h5>
                                    <h5 class="text-secondary">コンテンツ保存可能数：<span class="text-dark">無制限</span></h5>
                                </div><!--border-->
                            </div><!--プレミアムプラン-->
                        </div><!--row-->
                    </div><!--container-fluid-->
                </div><!--modal-body-->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
                </div><!-- /.modal-footer -->
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel2">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel2">オプション比較表</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="閉じる">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h5 class="pl-3">さらに詳しいサービス紹介サイトは<a href="{% url 'accounts:help' %}" target="_blank">こちら</a>！</h5>
                    <div class="container-fluid">
                        <div class="p-0">
                            <div class="my-3 p-2 border-option option_info1">
                                <div class="row bg-option py-3 text-option m-0">
                                    <div class="col-4 h4 option_title1 pl-3"></div>
                                    <div class="col-8 h5 option_detail1 mt-1"></div>
                                </div>
                                <div class="row m-0 py-3 text-center text-option">
                                    <div class="col-4">
                                        <h5 class="option-price1_1"></h5>
                                        <h5 class="text-secondary option-1_1"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price1_2"></h5>
                                        <h5 class="text-secondary option-1_2"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price1_3"></h5>
                                        <h5 class="text-secondary option-1_3"></h5>
                                    </div>
                                </div>
                            </div><!--border-->
                            <div class="my-3 p-2 border-option option_info2">
                                <div class="row bg-option py-3 text-option m-0">
                                    <div class="col-4 h4 option_title2 pl-3"></div>
                                    <div class="col-8 h5 option_detail2 mt-1"></div>
                                </div>
                                <div class="row m-0 py-3 text-center text-option">
                                    <div class="col-4">
                                        <h5 class="option-price2_1"></h5>
                                        <h5 class="text-secondary option-2_1"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price2_2"></h5>
                                        <h5 class="text-secondary option-2_2"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price2_3"></h5>
                                        <h5 class="text-secondary option-2_3"></h5>
                                    </div>
                                </div>
                            </div><!--border-->
                            <div class="my-3 p-2 border-option option_info3">
                                <div class="row bg-option py-3 text-option m-0">
                                    <div class="col-4 h4 option_title3 pl-3"></div>
                                    <div class="col-8 h5 option_detail3 mt-1"></div>
                                </div>
                                <div class="row m-0 py-3 text-center text-option">
                                    <div class="col-4">
                                        <h5 class="option-price3_1"></h5>
                                        <h5 class="text-secondary option-3_1"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price3_2"></h5>
                                        <h5 class="text-secondary option-3_2"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price3_3"></h5>
                                        <h5 class="text-secondary option-3_3"></h5>
                                    </div>
                                </div>
                            </div><!--border-->
                            <div class="my-3 p-2 border-option option_info4">
                                <div class="row bg-option py-3 text-option m-0">
                                    <div class="col-4 h4 option_title4 pl-3"></div>
                                    <div class="col-8 h5 option_detail4 mt-1"></div>
                                </div>
                                <div class="row m-0 py-3 text-center text-option">
                                    <div class="col-4">
                                        <h5 class="option-price4_1"></h5>
                                        <h5 class="text-secondary option-4_1"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price4_2"></h5>
                                        <h5 class="text-secondary option-4_2"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price4_3"></h5>
                                        <h5 class="text-secondary option-4_3"></h5>
                                    </div>
                                </div>
                            </div><!--border-->
                            <div class="my-3 p-2 border-option option_info5">
                                <div class="row bg-option py-3 text-option m-0">
                                    <div class="col-4 h4 option_title5 pl-3"></div>
                                    <div class="col-8 h5 option_detail5 mt-1"></div>
                                </div>
                                <div class="row m-0 py-3 text-center text-option">
                                    <div class="col-4">
                                        <h5 class="option-price5_1"></h5>
                                        <h5 class="text-secondary option-5_1"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price5_2"></h5>
                                        <h5 class="text-secondary option-5_2"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price5_3"></h5>
                                        <h5 class="text-secondary option-5_3"></h5>
                                    </div>
                                </div>
                            </div><!--border-->
                        </div><!--ライトプラン-->
                    </div><!--container-fluid-->
                </div><!--modal-body-->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
                </div><!-- /.modal-footer -->
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <!-- キャンセル確認用 -->
    <div class="modal fade" id="cancel_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <h6>現在の入力した内容は全て破棄されます。</h6>
                </div>
                <div class="modal-footer">
                    <button type="button" class="my-btn my-btn-accept my-btn-sm my-btn-w6" onclick="location.href='{% url 'contracts:estimate_cancel' %}'">OK</button>
                    <button type="button" class="my-btn my-btn-cancel my-btn-sm my-btn-w6" data-dismiss="modal">戻る</button>
                </div><!-- /.modal-footer -->
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
{% endblock %}
{% block extra_js %}
    <script src="{% static 'payment/js/option_list.js' %}"></script>
    <script src="{% static 'contracts/js/ttl_create_return.js' %}"></script>
    <script>
        $(function(){

            // 戻るボタンで戻った時に値が入ったらボタンを有効化
            $('form[data-validate]').each(function(){
                $(this).find(':submit').prop('disabled', !this.checkValidity());
            });

            // 値が入ったらボタンを有効化
            $('form[data-validate]').on('change dp.change', function () {
                $(this).find(':submit').prop('disabled', !this.checkValidity());
            });

            // 配布期間のコピー
            $("#dist_date_copy").on("click", function() {
                var id_dist_start_date = $("#id_dist_start_date").val()
                var id_dist_end_date = $("#id_dist_end_date").val()
                $("#id_sub_start_date").val(id_dist_start_date).change();;
                $("#id_sub_end_date").val(id_dist_end_date).change();;
            });

            /* ---------------------

            配布期間用のボタン

            --------------------- */

            // 現在時刻の取得
            var date = new Date();
            var year_str = date.getFullYear();
            var month_str = date.getMonth() + 1;
            var day_str = date.getDate();

            /*0時のプリセットボタン*/
            $('.start_preset_btn').on('click', function() {
                // 値の取得
                value = $("#id_dist_start_date").val();
                // 日付と時間を分割
                date = value.split(" ")
                // 時間を0時にした日時を生成
                if (value) {
                    format_str = date[0] + " 00:00:00"
                } else {
                    format_str = year_str + "/" + month_str + "/" + day_str + " 00:00:00"
                }
                // 値をセット
                $("#id_dist_start_date").val(format_str);
            });

            /*23時のプリセットボタン*/
            $('.end_preset_btn').on('click', function() {
                // 値の取得
                value = $("#id_dist_end_date").val();
                // 日付と時間を分割
                date = value.split(" ")
                // 時間を23:59:59時にした日時を生成
                if (value) {
                    format_str = date[0] + " 23:59:59"
                } else {
                    format_str = year_str + "/" + month_str + "/" + day_str + " 23:59:59"
                }
                // 値をセット
                $("#id_dist_end_date").val(format_str);
            });

            /*公開開始日の今すぐボタン*/
            $('.dis_now_start_date_btn').on('click', function() {
                var date = new Date();
                var year_str = date.getFullYear();
                var month_str = date.getMonth() + 1;
                var day_str = date.getDate();
                var hour_str = date.getHours();
                var minute_str = date.getMinutes();
                var second_str = date.getSeconds();

                month_str = ('0' + month_str).slice(-2);
                day_str = ('0' + day_str).slice(-2);
                hour_str = ('0' + hour_str).slice(-2);
                minute_str = ('0' + minute_str).slice(-2);

                format_str = 'YYYY-MM-DD hh:mm:ss';
                format_str = format_str.replace(/YYYY/g, year_str);
                format_str = format_str.replace(/MM/g, month_str);
                format_str = format_str.replace(/DD/g, day_str);
                format_str = format_str.replace(/hh/g, hour_str);
                format_str = format_str.replace(/mm/g, minute_str);
                format_str = format_str.replace(/ss/g, '00');

                $("#id_dist_start_date").val(format_str);
            });

            /*公開終了日の当日ボタン*/
            $('.dis_now_end_date_today_btn').on('click', function() {
                var date = new Date();
                var year_str = date.getFullYear();
                var month_str = date.getMonth() + 1;
                var day_str = date.getDate();

                month_str = ('0' + month_str).slice(-2);
                day_str = ('0' + day_str).slice(-2);

                format_str = 'YYYY-MM-DD hh:mm:ss';
                format_str = format_str.replace(/YYYY/g, year_str);
                format_str = format_str.replace(/MM/g, month_str);
                format_str = format_str.replace(/DD/g, day_str);
                format_str = format_str.replace(/hh/g, '23');
                format_str = format_str.replace(/mm/g, '59');
                format_str = format_str.replace(/ss/g, '59');

                $("#id_dist_end_date").val(format_str);
            });

            /*公開終了日の3日後ボタン*/
            $('.dis_now_end_date_3day_btn').on('click', function() {
                var date = new Date();
                date.setDate(date.getDate() + 2)
                var year_str = date.getFullYear();
                var month_str = date.getMonth() + 1;
                var day_str = date.getDate();

                month_str = ('0' + month_str).slice(-2);
                day_str = ('0' + day_str).slice(-2);

                format_str = 'YYYY-MM-DD hh:mm:ss';
                format_str = format_str.replace(/YYYY/g, year_str);
                format_str = format_str.replace(/MM/g, month_str);
                format_str = format_str.replace(/DD/g, day_str);
                format_str = format_str.replace(/hh/g, '23');
                format_str = format_str.replace(/mm/g, '59');
                format_str = format_str.replace(/ss/g, '59');

                $("#id_dist_end_date").val(format_str);
            });

            /*公開終了日の1週間後ボタン*/
            $('.dis_now_end_date_1week_btn').on('click', function() {
                var date = new Date();
                date.setDate(date.getDate() + 6)
                var year_str = date.getFullYear();
                var month_str = date.getMonth() + 1;
                var day_str = date.getDate();

                month_str = ('0' + month_str).slice(-2);
                day_str = ('0' + day_str).slice(-2);

                format_str = 'YYYY-MM-DD hh:mm:ss';
                format_str = format_str.replace(/YYYY/g, year_str);
                format_str = format_str.replace(/MM/g, month_str);
                format_str = format_str.replace(/DD/g, day_str);
                format_str = format_str.replace(/hh/g, '23');
                format_str = format_str.replace(/mm/g, '59');
                format_str = format_str.replace(/ss/g, '59');

                $("#id_dist_end_date").val(format_str);
            });

            /*公開終了日の1ヶ月後ボタン*/
            $('.dis_now_end_date_1month_btn').on('click', function() {
                var date = new Date();
                date.setMonth(date.getMonth() + 1)
                var year_str = date.getFullYear();
                var month_str = date.getMonth() + 1;
                var day_str = date.getDate();

                month_str = ('0' + month_str).slice(-2);
                day_str = ('0' + day_str).slice(-2);

                format_str = 'YYYY-MM-DD hh:mm:ss';
                format_str = format_str.replace(/YYYY/g, year_str);
                format_str = format_str.replace(/MM/g, month_str);
                format_str = format_str.replace(/DD/g, day_str);
                format_str = format_str.replace(/hh/g, '23');
                format_str = format_str.replace(/mm/g, '59');
                format_str = format_str.replace(/ss/g, '59');

                $("#id_dist_end_date").val(format_str);
            });

            /*公開終了日の無期限ボタン*/
            $('.dis_now_end_date_indefinite_btn').on('click', function() {
                var date = new Date(2099, 11, 31);
                // date.setMonth(date.getMonth() + 1)
                var year_str = date.getFullYear();
                var month_str = date.getMonth() + 1;
                var day_str = date.getDate();

                month_str = ('0' + month_str).slice(-2);
                day_str = ('0' + day_str).slice(-2);

                format_str = 'YYYY-MM-DD hh:mm:ss';
                format_str = format_str.replace(/YYYY/g, year_str);
                format_str = format_str.replace(/MM/g, month_str);
                format_str = format_str.replace(/DD/g, day_str);
                format_str = format_str.replace(/hh/g, '23');
                format_str = format_str.replace(/mm/g, '59');
                format_str = format_str.replace(/ss/g, '59');

                $("#id_dist_end_date").val(format_str);
            });

            /* ---------------------

            提出期間用のボタン

            --------------------- */

            /*公開開始日の今すぐボタン*/
            $('.sub_now_start_date_btn').on('click', function() {
                var date = new Date();
                var year_str = date.getFullYear();
                var month_str = date.getMonth() + 1;
                var day_str = date.getDate();
                var hour_str = date.getHours();
                var minute_str = date.getMinutes();
                var second_str = date.getSeconds();

                month_str = ('0' + month_str).slice(-2);
                day_str = ('0' + day_str).slice(-2);
                hour_str = ('0' + hour_str).slice(-2);
                minute_str = ('0' + minute_str).slice(-2);

                format_str = 'YYYY-MM-DD hh:mm:ss';
                format_str = format_str.replace(/YYYY/g, year_str);
                format_str = format_str.replace(/MM/g, month_str);
                format_str = format_str.replace(/DD/g, day_str);
                format_str = format_str.replace(/hh/g, hour_str);
                format_str = format_str.replace(/mm/g, minute_str);
                format_str = format_str.replace(/ss/g, '00');

                $("#id_sub_start_date").val(format_str);
            });

            /*公開終了日の当日ボタン*/
            $('.sub_now_end_date_today_btn').on('click', function() {
                var date = new Date();
                var year_str = date.getFullYear();
                var month_str = date.getMonth() + 1;
                var day_str = date.getDate();

                month_str = ('0' + month_str).slice(-2);
                day_str = ('0' + day_str).slice(-2);

                format_str = 'YYYY-MM-DD hh:mm:ss';
                format_str = format_str.replace(/YYYY/g, year_str);
                format_str = format_str.replace(/MM/g, month_str);
                format_str = format_str.replace(/DD/g, day_str);
                format_str = format_str.replace(/hh/g, '23');
                format_str = format_str.replace(/mm/g, '59');
                format_str = format_str.replace(/ss/g, '59');

                $("#id_sub_end_date").val(format_str);
            });

            /*公開終了日の3日後ボタン*/
            $('.sub_now_end_date_3day_btn').on('click', function() {
                var date = new Date();
                date.setDate(date.getDate() + 2)
                var year_str = date.getFullYear();
                var month_str = date.getMonth() + 1;
                var day_str = date.getDate();

                month_str = ('0' + month_str).slice(-2);
                day_str = ('0' + day_str).slice(-2);

                format_str = 'YYYY-MM-DD hh:mm:ss';
                format_str = format_str.replace(/YYYY/g, year_str);
                format_str = format_str.replace(/MM/g, month_str);
                format_str = format_str.replace(/DD/g, day_str);
                format_str = format_str.replace(/hh/g, '23');
                format_str = format_str.replace(/mm/g, '59');
                format_str = format_str.replace(/ss/g, '59');

                $("#id_sub_end_date").val(format_str);
            });

            /*公開終了日の1週間後ボタン*/
            $('.sub_now_end_date_1week_btn').on('click', function() {
                var date = new Date();
                date.setDate(date.getDate() + 6)
                var year_str = date.getFullYear();
                var month_str = date.getMonth() + 1;
                var day_str = date.getDate();

                month_str = ('0' + month_str).slice(-2);
                day_str = ('0' + day_str).slice(-2);

                format_str = 'YYYY-MM-DD hh:mm:ss';
                format_str = format_str.replace(/YYYY/g, year_str);
                format_str = format_str.replace(/MM/g, month_str);
                format_str = format_str.replace(/DD/g, day_str);
                format_str = format_str.replace(/hh/g, '23');
                format_str = format_str.replace(/mm/g, '59');
                format_str = format_str.replace(/ss/g, '59');

                $("#id_sub_end_date").val(format_str);
            });

            /*公開終了日の1ヶ月後ボタン*/
            $('.sub_now_end_date_1month_btn').on('click', function() {
                var date = new Date();
                date.setMonth(date.getMonth() + 1)
                var year_str = date.getFullYear();
                var month_str = date.getMonth() + 1;
                var day_str = date.getDate();

                month_str = ('0' + month_str).slice(-2);
                day_str = ('0' + day_str).slice(-2);

                format_str = 'YYYY-MM-DD hh:mm:ss';
                format_str = format_str.replace(/YYYY/g, year_str);
                format_str = format_str.replace(/MM/g, month_str);
                format_str = format_str.replace(/DD/g, day_str);
                format_str = format_str.replace(/hh/g, '23');
                format_str = format_str.replace(/mm/g, '59');
                format_str = format_str.replace(/ss/g, '59');

                $("#id_sub_end_date").val(format_str);
            });

            /*公開終了日の無期限ボタン*/
            $('.sub_now_end_date_indefinite_btn').on('click', function() {
                var date = new Date(2099, 11, 31);
                // date.setMonth(date.getMonth() + 1)
                var year_str = date.getFullYear();
                var month_str = date.getMonth() + 1;
                var day_str = date.getDate();

                month_str = ('0' + month_str).slice(-2);
                day_str = ('0' + day_str).slice(-2);

                format_str = 'YYYY-MM-DD hh:mm:ss';
                format_str = format_str.replace(/YYYY/g, year_str);
                format_str = format_str.replace(/MM/g, month_str);
                format_str = format_str.replace(/DD/g, day_str);
                format_str = format_str.replace(/hh/g, '23');
                format_str = format_str.replace(/mm/g, '59');
                format_str = format_str.replace(/ss/g, '59');

                $("#id_sub_end_date").val(format_str);
            });


            // 入力画面で画面遷移する際に確認画面を表示する。
            var checkValue = document.querySelectorAll('.form-control');
            var submitBtn = $(':submit');
            var checkFlag = false;
            var onBeforeunloadHandler = function(e) {
                var msg = 'このページから移動すると入力フォームの内容が消えます。';
                e.returnValue = msg;
            };
            var formAlert = function() {
                if(!checkFlag) {
                    window.addEventListener('beforeunload', onBeforeunloadHandler);
                for(var i = 0; i < checkValue.length; i++) {
                    checkValue[i].removeEventListener('input', formAlert);
                    checkValue[i].removeEventListener('change', formAlert);
                }
                checkFlag = true;
                }
            };
            for(var i = 0; i < checkValue.length; i++) {
                checkValue[i].addEventListener('input', formAlert);
                checkValue[i].addEventListener('change', formAlert);
            }
            // 次へボタンの時はイベントを削除
            $(submitBtn).on("click", function() {
                window.removeEventListener('beforeunload', onBeforeunloadHandler);
            });
            $('#logout_btn').on("click", function() {
                window.removeEventListener('beforeunload', onBeforeunloadHandler);
            });

            // ブラウザの戻るボタン無効化
            history.pushState(null, null, null);
            $(window).on("popstate", function (event) {
                $('.my_alert').css('display', 'block')
                $('.my_msg').text('ブラウザの戻るボタンは使用できません。ページ内の戻るまたはキャンセルボタンをご利用ください。')
                if (!event.originalEvent.state) {
                    history.pushState(null, null, null);
                    return;
                }
            });
            history.forward();
  
            /* ---------------------

            プレビュー表示

            --------------------- */
            //合計用
            pl_p = 0;//plan_price
            op_p = 0;//option
            to_p = 0;//total

            var plan_prices = $('[name=plan_price]').text()
            let pricesAry = plan_prices.split('/年');
            $('.plan-price1').text(pricesAry[0] + '円/年')
            $('.plan-price2').text(pricesAry[1] + '円/年')
            $('.plan-price3').text(pricesAry[2] + '円/年')

    
            //プラン表示
            $('[name=plan]').on('change, input, click', function(){
                var id = $(this).attr('id');
                var label = $('label[for="' + id + '"]').text();
                // jQuery.trim()で空白削除
                var name = $.trim(label);
                var price = $('label[for="' + id + '"]').data('price');
                
                $('#s_plan').text(name);
                $('#p_price').text(price + '/年');
                
                pl_p = Number(price.replace(/[^0-9]/g, ''));
                to_p = pl_p + op_p;
                to_p2 =String(to_p).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');

                //0円以下の場合は0にする
                if(to_p < 0){
                    $('#total_price').text(0);
                }else{
                    $('#total_price').text(to_p2 +'/年');
                };
                
                $('#p_price').show();
                $('#total_price').show();
            });

    
            //オプション表示
            var op_price1 = 0;
            var op_price2 = 0;
            var op_price3 = 0;
            var op_price4 = 0;
            var op_price5 = 0;

            $('[name=option1]').on('change, input', function(){
                $(".opname_1").remove();
                $('.opprice_1').remove();
                op_p = 0;
                var id = $(this).attr('id');
                //オプション名取得
                var label = $('label[for="' + id + '"]').text();
                var name = $.trim(label);

                //値段取得
                if(name !== 'なし'){
                    var price = $('label[for="' + id + '"]').data('price');
                    var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
                    price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
                    op_price1 = price2;
                    $("#s_option").append('<h6 class="opname_1">' + name + '</h6>');
                    $('#o_price').append('<h6 class="opprice_1">' + price3 + '/年' + '</h6>');
                }else{
                op_price1 = 0;
                };
            });
            $('[name=option2]').on('change, input', function(){
                $(".opname_2").remove();
                $('.opprice_2').remove();
                op_p = 0;
                var id = $(this).attr('id');
                //オプション名取得
                var label = $('label[for="' + id + '"]').text();
                var name = $.trim(label);

                //値段取得
                if(name !== 'なし'){
                    var price = $('label[for="' + id + '"]').data('price');
                    var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
                    price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
                    op_price2 = price2;

                    $("#s_option").append('<h6 class="opname_2">' + name + '</h6>');
                    $('#o_price').append('<h6 class="opprice_2">' + price3 + '/年' + '</h6>');
                }else{
                    op_price2 = 0;
                };
            });
            $('[name=option3]').on('change, input', function(){
                $(".opname_3").remove();
                $('.opprice_3').remove();
                op_p = 0;
                var id = $(this).attr('id');
                //オプション名取得
                var label = $('label[for="' + id + '"]').text();
                var name = $.trim(label);

                //値段取得
                if(name !== 'なし'){
                    var price = $('label[for="' + id + '"]').data('price');
                    var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
                    price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
                    op_price3 = price2;
                    $("#s_option").append('<h6 class="opname_3">' + name + '</h6>');
                    $('#o_price').append('<h6 class="opprice_3">' + price3 + '/年' + '</h6>');
                }else{
                    op_price3 = 0;
                };
            });
            $('[name=option4]').on('change, input', function(){
                $(".opname_4").remove();
                $('.opprice_4').remove();
                op_p = 0;
                var id = $(this).attr('id');
                //オプション名取得
                var label = $('label[for="' + id + '"]').text();
                var name = $.trim(label);

                //値段取得
                if(name !== 'なし'){
                    var price = $('label[for="' + id + '"]').data('price');
                    var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
                    price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
                    op_price4 = price2;

                    $("#s_option").append('<h6 class="opname_4">' + name + '</h6>');
                    $('#o_price').append('<h6 class="opprice_4">' + price3 + '/年' + '</h6>');
                }else{
                    op_price4 = 0;
                };
            });
            $('[name=option5]').on('change, input', function(){
                $(".opname_5").remove();
                $('.opprice_5').remove();
                op_p = 0;
                var id = $(this).attr('id');
                //オプション名取得
                var label = $('label[for="' + id + '"]').text();
                var name = $.trim(label);
                
                //値段取得
                if(name !== 'なし'){
                    var price = $('label[for="' + id + '"]').data('price');
                    var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
                    price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');

                    op_price5 = price2;

                    $("#s_option").append('<h6 class="opname_5">' + name + '</h6>');
                    $('#o_price').append('<h6 class="opprice_5">' + price3 + '/年' + '</h6>');
                }else{
                    op_price5 = 0;
                };
            });
            $('[name=option1],[name=option2],[name=option3],[name=option4],[name=option5]').on('change, input', function(){
                $('#total_price').empty();

                //値段合計
                op_p = op_price1 + op_price2 + op_price3 + op_price4 +op_price5;
                to_p = pl_p + op_p;
                to_p2 =String(to_p).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');

                //0円以下の場合は0にする
                if(to_p < 0){
                    $('#total_price').text(0);
                }else{
                    $('#total_price').text(to_p2 + '/年');
                };
                
                $("#s_option").show();
                $('#o_price').show();
                $('#total_price').show();
            }); 
        });
    </script>
{% endblock %}
