{% extends "common/base.html" %}

{% load i18n static %}
{% load humanize %}
{% load sort_by %}

{% block title %}申し込み{% endblock title %}

{% block breadcrumbtitle %}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-1">
            <li class="breadcrumb-item"><a href="{% url 'accounts:home' %}">ホーム</a></li>
            <li class="breadcrumb-item">契約管理</li>
            <li class="breadcrumb-item"><a href="{% url 'contracts:estimate' %}">見積一覧</a></li>
            <li class="breadcrumb-item active">申し込み</li>
        </ol>
    </nav>
{% endblock breadcrumbtitle %}

{% block content %}
    <div class="container offer p-0 pb-5 m-0">
        <div class="card border-0 card-register mt-0">
            <div class="card-body px-0">
                <table class="table table-bordered mb-5 pb-5">
                    <thead><h6 class="px-2">お見積り内容　　　　　　　　　　　　　　　　　　　　　　　　　　　　　単位：円</h6></thead>

                    <tbody>
                        <tr>
                            <th scope="row" class="tr_head">見積番号</th>
                            <td colspan="2">{{ estimate.num }}</td>
                        </tr>
                        <tr>
                            <th scope="row" class="offer_tr_head">サービス利用開始日</th>
                            <td colspan="2">{{ estimate.start_day|date:"Y年m月d日" }}</td>
                        </tr>
                        <tr>
                            <th scope="row" class="offer_tr_head">サービス名</th>
                            <td colspan="2">{{ estimate.service.name }}</td>
                        </tr>
                        <tr>
                            <th scope="row" class="offer_tr_head">プラン</th>
                            <td>{{ estimate.plan }}</td>
                            <td class="text-right">{{ estimate.plan.price|intcomma }}/年</td>
                        </tr>
                        <tr>
                            <th scope="row" class="offer_tr_head">オプション</th>
                            {% if estimate.option1 or estimate.option2 or estimate.option3 or estimate.option4 or estimate.option5 %}
                            <td>
                                {% if estimate.option1 %}
                                {{ estimate.option1.name }}<br>
                                {% endif %}
                                {% if estimate.option2 %}
                                {{ estimate.option2.name }}<br>
                                {% endif %}
                                {% if estimate.option3 %}
                                {{ estimate.option3.name }}<br>
                                {% endif %}
                                {% if estimate.option4 %}
                                {{ estimate.option4.name }}<br>
                                {% endif %}
                                {% if estimate.option5 %}
                                {{ estimate.option5.name }}
                                {% endif %}
                            </td>
                            <td class="text-right">
                                {% if estimate.option1 %}
                                {{ estimate.option1.price|intcomma }}/年<br>
                                {% endif %}
                                {% if estimate.option2 %}
                                {{ estimate.option2.price|intcomma }}/年<br>
                                {% endif %}
                                {% if estimate.option3 %}
                                {{ estimate.option3.price|intcomma }}/年<br>
                                {% endif %}
                                {% if estimate.option4 %}
                                {{ estimate.option4.price|intcomma }}/年<br>
                                {% endif %}
                                {% if estimate.option5 %}
                                {{ estimate.option5.price|intcomma }}/年
                                {% endif %}
                            </td>
                            {% else %}
                            <td colspan="2">なし</td>
                            {% endif %}
                        </tr>
                        <tr>
                            <th scope="row"  class="tr_head">割引</th>
                            {% if estimate.discount %}
                            <tr>
                                <th scope="row" class="tr_head">{{ estimate.discount.name }}</th>
                                <td colspan="2" class="text-right">-{{ estimate.discount.discount_rate|intcomma }}</td>
                            </tr>
                            {% else %}
                                <td colspan="2">なし</td>    
                            {% endif %}
                        </tr>
                    </tbody>
                </table>
                <table class="table">
                    <tbody>
                        <tr>
                            <th class="table-blank border-0"></th>
                            <th scope="row" class="offer_tr_head tr_gray h6 border">年額利用料</th>
                            <td colspan="2" class="text-right h6 border">{{ estimate.unit_total|intcomma }}&nbsp;({{ estimate.unit_minor_total|intcomma }}/月)</td>
                        </tr>
                        <tr>
                            <th class="table-blank border-0"></th>
                            <th scope="row" class="offer_tr_head tr_gray h6 border">小計(税抜)</th>
                            <td colspan="2" class="text-right h6 border">{{ estimate.minor_total|intcomma }}</td>
                        </tr>
                        <tr>
                            <th class="table-blank border-0"></th>
                            <th scope="row" class="offer_tr_head tr_gray h6 border">消費税(<span class="tax-rate">10</span>%)</th>
                            <td colspan="2" class="text-right h6 border">{{ estimate.tax|intcomma }}</td>
                        </tr>
                        <tr>
                            <th class="table-blank border-0"></th>
                            <th scope="row" class="offer_tr_head tr_gray h6 font-weight-bold border">合計(税込)</th>
                            <td colspan="2" class="text-right font-weight-bold h5 border">{{ estimate.total|intcomma }}</td>
                        </tr>
                    </tbody>
                </table>
                <form action="" method="post" id="form_payment">
                    {% csrf_token %}
                    <div class="btn-toolbar fixed-bottom p-3">  
                        <div class="row mx-auto">
                            <h5 class="align-middle d-block m-2 tool-text">ご確認の上、「申し込む」ボタンを押してください。</h5>
                            <button type="button" class="btn my-btn-w11 mr-1 my-btn-accept text-center" data-toggle="modal" data-target="#payment_confirm" onfocus="this.blur();">申し込む<span class="check"></span></button>
                            <button type="button" class="btn my-btn-w11 mr-3 my-btn-cancel cancel" data-toggle="modal" data-target="#cancel_modal" onfocus="this.blur();">キャンセル</button>
                        </div>
                    </div><!--toolbar-->
                
                    {% comment %} <div class="row">
                        <div class="col-sm-6">
                        <a href="{% url 'contracts:estimate' %}" class="my-btn my-btn-cancel my-btn-block" onfocus="this.blur();">キャンセル</a>
                        </div>
                        <div class="col-sm-6">
                        <button type="button" class="my-btn my-btn-accept my-btn-block" data-toggle="modal" data-target="#payment_confirm" onfocus="this.blur();">申し込む</button>
                        
                        </div>
                    </div> {% endcomment %}
                </form>
            </div><!--cardbody-->
        </div><!--card-->
    </div><!--container-->
    <!-- 支払い確認用モーダル用 -->
    <div class="modal fade" id="payment_confirm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <h6>入金の確認が取れ次第利用可能となります。<br>
                    「申し込む」ボタンをクリックすると契約が締結します。</h6>
                </div>
                <div class="modal-footer">
                    <button type="submit" id="autocheckoutcheckout_button" form="form_payment" class="my-btn my-btn-accept my-btn-sm my-btn-w6">申し込む</button>
                    <button type="button" class="btn my-btn-cancel my-btn-sm my-btn-w6" data-dismiss="modal">キャンセル</button>
                </div><!-- /.modal-footer -->
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <!-- キャンセル確認用 -->
    <div class="modal fade" id="cancel_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <h6>手続きを中断します。</h6>
                </div>
                <div class="modal-footer">
                    <button type="button" class="my-btn my-btn-accept my-btn-sm my-btn-w6" onclick="location.href='{% url 'contracts:estimate_cancel' %}'">OK</button>
                    <button type="button" class="my-btn my-btn-cancel my-btn-sm my-btn-w6" data-dismiss="modal">戻る</button>
                </div><!-- /.modal-footer -->
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
{% endblock %}

{% block extra_js %}
    <script>
        $(document).ready(function() {

            function loadingView(flag) {
                $('#loading-view').remove();
                if(!flag) return;
                $('<div id="loading-view" />').appendTo('body');
            }

            $("#autocheckoutcheckout_button").click( function() {
                console.log("ボタンを押したぞ")
                // 処理前に Loading 画像を表示
                loadingView(true);
            });

        });

    </script>
{% endblock %}