{% extends "common/base.html" %}

{% load i18n static %}
{% load humanize %}
{% load sort_by %}

{% block title %}申し込み{% endblock title %}

{% block breadcrumbtitle %}

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-1">
            <li class="breadcrumb-item"><a href="{% url 'accounts:home' %}">ホーム</a></li>
            <li class="breadcrumb-item">契約管理</li>
            <li class="breadcrumb-item"><a href="{% url 'contracts:contract' %}">ご契約状況</a></li>
            <li class="breadcrumb-item active">申し込み</li>
        </ol>
    </nav>

    {% comment %} <a class="help_icon" href="{% url 'help:checkout' %}" target="_blank"><i class="fas fa-question-circle"></i></a> {% endcomment %}

{% endblock breadcrumbtitle %}

{% block content %}

    <!-- ステップ -->
    <ul class="progressbar pt-4">
        <li class="complete">プランの選択</li>
        <li class="complete">支払い方法の選択</li>
        <li class="complete">申込み内容確認</li>
        <li>申し込み完了</li>
    </ul>

    <div class="container offer p-0 mx-0 pt-5">
        <div class="card border-0 card-register mt-0">
            <div class="card-body p-0 pb-5 mb-5 ">
                <form action="" method="post" id="form_payment">

                    <table class="table table-bordered">
                        <thead><h6 class="px-2">お見積り内容　　　　　　　　　　　　　　　　　　　　　　　　　　　　　単位：円</h6></thead>
                        <tbody>
                            <tr>
                                <th scope="row" class="tr_head">見積番号</th>

                                <td colspan="2">{{ estimate.num }}</td>
                            </tr>
                            <tr>
                                <th scope="row" class="tr_head">サービス利用開始日</th>
                                <td colspan="2">{{ estimate.start_day|date:'Y年m月d日' }}（1年間）<br>
                                        {% comment %} <input type="checkbox" name="is_start_now" id="is_start_now" >
                                        <label for="is_start_now">
                                        <span>今すぐ開始</span>
                                        </label> {% endcomment %}
                                </td>
                            </tr>
                            <tr>
                                <th scope="row" class="tr_head">サービス名</th>
                                <td colspan="2">{{ estimate.service.name }}</td>
                            </tr>
                            <tr>
                                <th scope="row" class="tr_head">プラン</th>
                                <td>{{ estimate.plan }}</td>
                                <td class="text-right">{{ estimate.plan.price|intcomma }}/年</td>
                            </tr>
                            <tr>
                                <th scope="row" class="tr_head">オプション</th>
                                {% if estimate.option1 or estimate.option2 or estimate.option3 or estimate.option4 or estimate.option5 %}
                                    <td>
                                        {% if estimate.option1 %}
                                            {{ estimate.option1.name }}<br>
                                        {% endif %}
                                        {% if estimate.option2 %}
                                            {{ estimate.option2.name }}<br>
                                        {% endif %}
                                        {% if estimate.option3 %}
                                            {{ estimate.option3.name }}<br>
                                        {% endif %}
                                        {% if estimate.option4 %}
                                            {{ estimate.option4.name }}<br>
                                        {% endif %}
                                        {% if estimate.option5 %}
                                            {{ estimate.option5.name }}
                                        {% endif %}
                                    </td>
                                    <td class="text-right">
                                        {% if estimate.option1 %}
                                            {{ estimate.option1.price|intcomma }}/年<br>
                                        {% endif %}
                                        {% if estimate.option2 %}
                                            {{ estimate.option2.price|intcomma }}/年<br>
                                        {% endif %}
                                        {% if estimate.option3 %}
                                            {{ estimate.option3.price|intcomma }}/年<br>
                                        {% endif %}
                                        {% if estimate.option4 %}
                                            {{ estimate.option4.price|intcomma }}/年<br>
                                        {% endif %}
                                        {% if estimate.option5 %}
                                            {{ estimate.option5.price|intcomma }}/年
                                        {% endif %}
                                    </td>
                                {% else %}
                                    <td colspan="2">なし</td>
                                {% endif %}
                            </tr>
                            <tr>
                                <th scope="row" class="tr_head">
                                    <div class="required_box">
                                        <div class="label require_label">自動更新</div>
                                    </div>
                                </th>
                                <td colspan="2">
                                    <div>
                                        <input class="checkout_input" type="radio" value="True" name="autocheckout" checked/><label class="mr-2">有効</label>
                                        <input class="checkout_input" type="radio" value="False" name="autocheckout"/><label>無効</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"  class="tr_head">割引</th>
                                {% if estimate.discount and estimate.method_payment_id == 1 %}
                                    {% if estimate.unit_total >= 30000 %}
                                        <td>クレジットカード支払割引<br>
                                        {{ estimate.discount.name }}</td>
                                        <td class="text-right">-{{ estimate.method_payment.payment_discount|intcomma }}<br>
                                        -{{ estimate.discount.discount_rate|intcomma }}</td>
                                    {% else %}
                                        <td>{{ estimate.discount.name }}</td>
                                        <td class="text-right">-{{ estimate.discount.discount_rate|intcomma }}</td>
                                    {% endif %}
                                {% elif estimate.method_payment_id == 1 and estimate.unit_total >= 30000 %}
                                    <td>クレジットカード支払割引</td>
                                    <td class="text-right">-{{ estimate.method_payment.payment_discount|intcomma }}</td>
                                {% elif estimate.discount %}
                                    <td>{{ estimate.discount.name }}</td>
                                    <td class="text-right">-{{ estimate.discount.discount_rate|intcomma }}</td>
                                {% else %}
                                    <td colspan="2">なし</td>
                                {% endif %}
                            </tr>
                        </tbody>
                    </table>
                    <table class="table">
                        <tbody>
                            <tr>
                                <th class="table-blank border-0"></th>
                                <th scope="row" class="tr_head tr_gray h6 border">年額利用料</th>
                                <td colspan="2" class="text-right h6 border">{{ estimate.unit_total|intcomma }}&nbsp;({{ estimate.unit_minor_total|intcomma }}/月)</td>
                            </tr>
                            <tr>
                                <th class="table-blank border-0"></th>
                                <th scope="row" class="tr_head tr_gray h6 border">小計(税抜)</th>
                                <td colspan="2" class="text-right h6 border">{{ estimate.minor_total|intcomma }}</td>
                            </tr>
                            <tr>
                                <th class="table-blank border-0"></th>
                                <th scope="row" class="tr_head tr_gray h6 border">消費税(<span class="tax-rate">10</span>%)</th>
                                <td colspan="2" class="text-right h6 border">{{ estimate.tax|intcomma }}</td>
                            </tr>
                            <tr>
                                <th class="table-blank border-0"></th>
                                <th scope="row" class="tr_head tr_gray h6 font-weight-bold border">合計(税込)</th>
                                <td colspan="2" class="text-right font-weight-bold h5 border">{{ estimate.total|intcomma }}</td>
                            </tr>
                        </tbody>
                    </table>

                    {% csrf_token %}

                    {% comment %} <div class="row">

                    <div class="col-sm-4">
                        <div class=btn_box>
                        <a href="{% url 'contracts:offer_step2' %}" onfocus="this.blur();" class="btn my-btn-accept btn-block cancel_btn"><span class="cancel">戻る</span></a>
                        </div>
                    </div>

                    <div class="col-sm-4">
                        <div class=btn_box>
                        <a href="{% url 'contracts:offer_cancel' %}" class="my-btn my-btn-cancel my-btn-block" onfocus="this.blur();"><span class="cancel">キャンセル</span></a>
                        </div>
                    </div>

                    <div class="col-sm-4">
                        <div class=btn_box>
                        <button type="button" class="my-btn my-btn-accept my-btn-block" id="offer_button"><span class="next">申し込む</span></button>
                        </div>
                    </div>

                    </div> {% endcomment %}
                    <div class="btn-toolbar fixed-bottom p-3 ">  

                        <div class="row mx-auto">
                            <button type="button" class="btn my-btn-w11 mr-3 my-btn-cancel cancel" data-toggle="modal" data-target="#cancel_modal" onfocus="this.blur();">キャンセル</button>
                            <h5 class="align-middle d-block m-2 tool-text">ご確認の上、「確認」ボタンを押してください。</h5>
                            <button type="button" class="btn my-btn-w11 mr-2 my-btn-accept text-center" onclick="location.href='{% url 'contracts:estimate_return' %}'"><span class="return2"></span>戻る</button>
                            <button type="button" class="btn my-btn-w11 mr-1 my-btn-accept text-center" data-toggle="modal" data-target="#payment_confirm" id="send" onfocus="this.blur();">確認<span class="check"></span></button>
                        </div>
                    </div>
                </form>
            </div><!--card-body-->
        </div><!--card-->
    </div><!--container-->

    <!-- 支払い確認用モーダル用 -->
    <div class="modal fade" id="payment_confirm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <h6>支払い処理を開始します。<br>
                    「申し込む」ボタンをクリックすると契約が締結します。</h6>
                </div>
                <div class="modal-footer">
                    <button type="submit" id="autocheckoutcheckout_button" form="form_payment" class="my-btn my-btn-accept my-btn-sm my-btn-w6">申し込む</button>
                    <button type="button" class="btn my-btn-cancel my-btn-sm my-btn-w6" data-dismiss="modal">キャンセル</button>
                </div><!-- /.modal-footer --> 
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade hide" data-keyboard="false" data-backdrop="static" id="payment_loading" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
            <div class="modal-body">
                <h6>支払い処理を開始します。そのままお待ちください。</h6>
            </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <!-- 自動更新説明用 -->
    <div class="modal fade" id="autocheckout_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <h6 id="auto-msg">XXX</h6>
                </div>
                <div class="modal-footer">
                    <button type="button" class="my-btn my-btn-accept my-btn-sm my-btn-w6" data-dismiss="modal">OK</button>
                </div><!-- /.modal-footer -->
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <!-- キャンセル確認用 -->
    <div class="modal fade" id="cancel_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <h6>現在の入力した内容は全て破棄されます。</h6>
                </div>
                <div class="modal-footer">
                    <button type="button" class="my-btn my-btn-accept my-btn-sm my-btn-w6" onclick="location.href='{% url 'contracts:estimate_cancel' %}'">OK</button>
                    <button type="button" class="my-btn my-btn-cancel my-btn-sm my-btn-w6" data-dismiss="modal">戻る</button>
                </div><!-- /.modal-footer -->
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

{% endblock %}

{% block extra_js %}
    <script>
        $(document).ready(function() {

            // 自動更新の説明を表示
            $("[name='autocheckout']").on('change', function() {
                console.log($(this).val())
                autocheckout = $(this).val()
                // 有効(True)の場合
                if (autocheckout == "True") {
                    $('#autocheckout_modal').on('show.bs.modal', function (e) {
                        var modal = $(this);
                        modal.find('#auto-msg').text("毎年クレジットカードから自動的に支払いが行われます。");
                    })
                    $('#autocheckout_modal').modal('show')
                // 無効(False)の場合
                } else {
                    $('#autocheckout_modal').on('show.bs.modal', function (e) {
                        var modal = $(this);
                        modal.find('#auto-msg').text("ご契約中のプランの有効期限までに手動にて支払い手続きを行って頂く必要があります。");
                    })
                    $('#autocheckout_modal').modal('show')
                }
            });

            function loadingView(flag) {
                $('#loading-view').remove();
                    if(!flag) return;
                $('<div id="loading-view" />').appendTo('body');
            }

            //  $("#autocheckoutcheckout_button").click( function() {
            //    // 処理前に Loading 画像を表示
            //    loadingView(true);
            //  });


            // 申し込みボタン押下
            $("#autocheckoutcheckout_button").click( function() {
                $('#payment_confirm').hide()
                // モーダル表示
                $('#payment_loading').modal('show')

                // 2秒待機
                setTimeout(function(){
                    // モーダル非表示
                    // $('#payment_confirm').modal('hide')

                    // ローディング
                    loadingView(true);

                    // サブミットする
                    $('#form_payment').submit()

                },3000);

            });


            // ブラウザの戻るボタン無効化
            history.pushState(null, null, null);
            $(window).on("popstate", function (event) {
                $('.my_alert').css('display', 'block')
                $('.my_msg').text('ブラウザの戻るボタンは使用できません。ページ内の戻るまたはキャンセルボタンをご利用ください。')
                if (!event.originalEvent.state) {
                    history.pushState(null, null, null);
                    return;
                }
            });
            history.forward();

        });

    </script>
{% endblock %}
