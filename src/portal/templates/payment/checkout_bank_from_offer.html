{% extends "common/base.html" %}

{% load i18n static %}
{% load humanize %}
{% load sort_by %}

{% block title %}申し込み{% endblock title %}

{% block breadcrumbtitle %}
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="{% url 'accounts:home' %}">ホーム</a></li>
        <li class="breadcrumb-item">契約管理</li>
        <li class="breadcrumb-item"><a href="{% url 'contracts:contract' %}">ご契約状況</a></li>
        <li class="breadcrumb-item active">申し込み</li>
    </ol>
  </nav>
  {% comment %} <a class="help_icon" href="{% url 'help:checkout' %}" target="_blank"><i class="fas fa-question-circle"></i></a> {% endcomment %}
{% endblock breadcrumbtitle %}

{% block content %}

<!-- ステップ -->
  <ul class="progressbar pt-4">
    <li class="complete">プランの選択</li>
    <li class="complete">支払い方法の選択</li>
    <li class="active">申込み内容確認</li>
    <li>申込み完了</li>
  </ul>

<div class="container estimate p-0 m-0 pt-5">
  <div class="card border-0 card-register mt-0 mb-5 pb-5">
    <div class="card-body p-0">
      <table class="table table-bordered">
        <thead><h6 class="px-2">お見積り内容　　　　　　　　　　　　　　　　　　　　　　　　　　　　　単位：円</h6></thead>

        <tbody>
          <tr>
            <th  scope="row" class="tr_head">見積番号</th>
            <td colspan="2">{{ estimate.num }}</td>
          </tr>
          <tr>
            <th scope="row" class="tr_head">サービス利用開始日</th>
            <td colspan="2">{{ estimate.start_day|date:'Y年m月d日' }}（1年間）</td>
          </tr>
          <tr>
            <th scope="row" class="tr_head">サービス名</th>
            <td colspan="2">{{ estimate.service.name }}</td>
          </tr>
          <tr>
            <th scope="row" class="tr_head">プラン</th>
            <td>{{ estimate.plan }}</td>
            <td class="text-right">{{ estimate.plan.price|intcomma }}/年</td>
          </tr>
          <tr>
            <th scope="row" class="tr_head">オプション</th>
            {% if estimate.option1 or estimate.option2 or estimate.option3 or estimate.option4 or estimate.option5 %}
              <td>
                {% if estimate.option1 %}
                  {{ estimate.option1.name }}<br>
                {% endif %}
                {% if estimate.option2 %}
                  {{ estimate.option2.name }}<br>
                {% endif %}
                {% if estimate.option3 %}
                  {{ estimate.option3.name }}<br>
                {% endif %}
                {% if estimate.option4 %}
                  {{ estimate.option4.name }}<br>
                {% endif %}
                {% if estimate.option5 %}
                  {{ estimate.option5.name }}
                {% endif %}
              </td>
              <td class="text-right">
                {% if estimate.option1 %}
                  {{ estimate.option1.price|intcomma }}/年<br>
                {% endif %}
                {% if estimate.option2 %}
                  {{ estimate.option2.price|intcomma }}/年<br>
                {% endif %}
                {% if estimate.option3 %}
                  {{ estimate.option3.price|intcomma }}/年<br>
                {% endif %}
                {% if estimate.option4 %}
                  {{ estimate.option4.price|intcomma }}/年<br>
                {% endif %}
                {% if estimate.option5 %}
                  {{ estimate.option5.price|intcomma }}/年
                {% endif %}
              </td>
            {% else %}
              <td colspan="2">なし</td>
            {% endif %}
          </tr>
          <tr>
            <th scope="row"  class="tr_head">割引</th>
            {% if estimate.discount %}
              {% comment %} <tr>
                <th scope="row" class="tr_head">{{ estimate.discount.name }}</th>
                <td class="text-right">-{{ estimate.discount.discount_rate|intcomma }}</td>
              </tr> {% endcomment %}
              <td>{{ estimate.discount.name }}</td>
              <td class="text-right">-{{ estimate.discount.discount_rate|intcomma }}</td>
            {% else %}
              <td colspan="2">なし</td>
            {% endif %}
          </tr>
        </tbody>
      </table>
      <table class="table">
        <tbody>
          <tr>
            <th class="table-blank border-0"></th>
            <th scope="row" class="tr_head tr_gray h6 border">年額利用料</th>
            <td colspan="2" class="text-right h6 border">{{ estimate.unit_total|intcomma }}&nbsp;({{ estimate.unit_minor_total|intcomma }}/月)</td>
          </tr>
          <tr>
            <th class="table-blank border-0"></th>
            <th scope="row" class="tr_head tr_gray h6 border">小計(税抜)</th>
            <td colspan="2" class="text-right h6 border">{{ estimate.minor_total|intcomma }}</td>
          </tr>
          <tr>
            <th class="table-blank border-0"></th>
            <th scope="row" class="tr_head tr_gray h6 border">消費税(<span class="tax-rate">10</span>%)</th>
            <td colspan="2" class="text-right h6 border">{{ estimate.tax|intcomma }}</td>
          </tr>
          <tr>
            <th class="table-blank border-0"></th>
            <th scope="row" class="tr_head tr_gray h6 border font-weight-bold">合計(税込)</th>
            <td colspan="2" class="text-right font-weight-bold h5 border">{{ estimate.total|intcomma }}</td>
          </tr>
        </tbody>
      </table>
      <form action="" method="post" id="form_payment">
        {% csrf_token %}

        {% comment %} <div class="row">
          <div class="col-4">
            <div class=btn_box>
              <button type="button" class="btn my-btn-cancel btn-block" onclick="location.href='{% url 'contracts:offer_step2' %}'"><span class="return">戻る</span></button>
            </div>
          </div>

          <div class="col-4">
            <button type="button" class="btn my-btn-cancel btn-block" onclick="location.href='{% url 'contracts:estimate' %}'"><span class="return">キャンセル</span></button>
          </div>

          <div class="col-4">
            <button type="button" class="my-btn my-btn-accept my-btn-block" data-toggle="modal" data-target="#payment_confirm" onfocus="this.blur();">申し込む</button>
          </div>
        </div> {% endcomment %}

        <div class="btn-toolbar fixed-bottom p-3">  

          <div class="row mx-auto">
              <button type="button" class="btn my-btn-w11 ml-1 my-btn-cancel cancel mr-5" data-toggle="modal" data-target="#cancel_modal" onfocus="this.blur();">キャンセル</button>
              <h5 class="align-middle d-block m-2 tool-text">ご確認の上、「申し込む」ボタンを押してください。</h5>
              <button type="button" class="btn my-btn-w11 mr-2 my-btn-accept text-center" onclick="location.href='{% url 'contracts:estimate_return' %}'"><span class="return2"></span>戻る</button>
              
              <button type="button" class="btn my-btn-w11 ml-2 my-btn-accept text-center" data-toggle="modal" data-target="#payment_confirm" onfocus="this.blur();">申し込む<span class="check"></span></button>
          </div><!--row-->
        </div><!--btn-toolbar-->
      </form>
    </div><!--cardbody-->
  </div><!--card-->
</div><!--container-->

<!-- 支払い確認用モーダル用 -->
<div class="modal fade" id="payment_confirm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <h6>入金の確認が取れ次第利用可能となります。<br>
          「申し込む」ボタンをクリックすると契約が締結します。</h6>
      </div>
      <div class="modal-footer">
        <button type="submit" id="autocheckoutcheckout_button" form="form_payment" class="my-btn my-btn-accept my-btn-sm my-btn-w6">申し込む</button>
        <button type="button" class="btn my-btn-cancel my-btn-sm my-btn-w6" data-dismiss="modal">キャンセル</button>
      
      </div><!-- /.modal-footer -->
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- キャンセル確認用 -->
<div class="modal fade" id="cancel_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <h6>現在の入力した内容は全て破棄されます。</h6>
      </div>
      <div class="modal-footer">
        <button type="button" class="my-btn my-btn-accept my-btn-sm my-btn-w6" onclick="location.href='{% url 'contracts:estimate_cancel' %}'">OK</button>
        <button type="button" class="my-btn my-btn-cancel my-btn-sm my-btn-w6" data-dismiss="modal">戻る</button>
      </div><!-- /.modal-footer -->
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function() {

  function loadingView(flag) {
    $('#loading-view').remove();
    if(!flag) return;
    $('<div id="loading-view" />').appendTo('body');
  }

  $("#autocheckoutcheckout_button").click( function() {
    console.log("ボタンを押したぞ")
    // 処理前に Loading 画像を表示
    loadingView(true);
  });


});

</script>
{% endblock %}
