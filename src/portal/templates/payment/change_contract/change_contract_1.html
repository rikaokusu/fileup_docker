{% extends "common/base.html" %}

{% load i18n static %}
{% load bootstrap4 %}
{% load humanize %}
{% load widget_tweaks %}
{% load is_exist %}

{% block title %}プラン・オプション変更{% endblock title %}

{% block breadcrumbtitle %}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="{% url 'accounts:home' %}">ホーム</a></li>
        <li class="breadcrumb-item active">プラン・オプション変更</li>
    </ol>
</nav>

{% endblock breadcrumbtitle %}

{% block extra_css %}{% endblock %}

{% block content %}

    <div class="card  border-0 mx-auto mt-5">
        <h5 class="estimate-guide"><i class="fas fa-feather"></i>&nbsp;プラン・オプション変更の流れ</h5>
        <h6 class="pt-2 py-3">
        １．変更ご希望のプランとオプションを選択してください<br>
        <span class="text-danger">　　※現在の契約より価格の低いプラン・オプションは選択できません。予めご了承ください。<br></span>
        ２．見積りの内容をご確認後、「次へ」を押してください。<br>
        <button type="button" class="btn my-btn-w9 mt-2 my-btn-accept" data-toggle="modal" data-target="#exampleModal">プラン比較表</button>
        <button type="button" class="btn my-btn-w12 mt-2 my-btn-accept" data-toggle="modal" data-target="#exampleModal2">オプション比較表</button>

        </h6>
        <h6 class="border p-2 mt-2 font-weight-bold border-danger text-danger min-price">選択したプラン・オプションの価格が現在契約しているプラン・オプションの価格を上回る変更のみ可能です。</h6>

        <!-- Form全体のバリデーション時のエラーを表示 -->
        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}

        <div class="card-body p-0">

            <form action="" method="post" data-validate>{% csrf_token %}
                <div class="row mx-auto estimate pb-5">
                    <div class="col-6 mb-5 pl-0">
                        <table class="table table-bordered">
                            <tbody>
                                <tr>
                                    <th class="tr_head">
                                        <div class="required_box">
                                            <div class="label require_label">プラン</div>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="">
                                            {% if form.is_bound %}
                                                {% if form.plan.errors %}
                                                    {% render_field form.plan class="form-control is-invalid" %}
                                                    {% for error in form.plan.errors %}
                                                        <div class="invalid-feedback">
                                                            {{ error }}
                                                        </div>
                                                    {% endfor %}
                                                {% else %}
                                                    {% render_field form.plan class="form-control is-valid" %}
                                                {% endif %}
                                            {% else %}<!-- 初期表示 -->
                                                {% render_field form.plan class="form-control" %}
                                            {% endif %}
                                        </div>
                                    </th>
                                </tr>
                                <tr>
                                    <th class="tr_head">
                                        <div class="required_box">
                                            <div class="label require_label">オプション</div>
                                        </div>
                                    </th>
                                    <th>
                                        {% if options_list|is_exist:form.option1.name %}
                                            <!-- オプション1 -->
                                            <div class="">
                                                <!-- 入力フィールド -->
                                                {% if form.is_bound %}
                                                    {% if form.option1.errors %}
                                                        {% render_field form.option1 class="form-control is-invalid" %}
                                                        {% for error in form.option1.errors %}
                                                            <div class="invalid-feedback">
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        {% render_field form.option1 class="form-control is-valid" %}
                                                    {% endif %}
                                                {% else %}<!-- 初期表示 -->
                                                    {% render_field form.option1  class="form-control" %}
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                        {% if options_list|is_exist:form.option2.name %}
                                            <hr>
                                            <!-- オプション2 -->
                                            <div class="">
                                                <!-- 入力フィールド -->
                                                {% if form.is_bound %}
                                                    {% if form.option2.errors %}
                                                        {% render_field form.option2 class="form-control is-invalid" %}
                                                        {% for error in form.option2.errors %}
                                                            <div class="invalid-feedback">
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        {% render_field form.option2 class="form-control is-valid" %}
                                                    {% endif %}
                                                {% else %}<!-- 初期表示 -->
                                                    {% render_field form.option2 class="form-control" %}
                                                {% endif %}
                                            </div>
                                        {% endif %}

                                        {% if options_list|is_exist:form.option3.name %}
                                            <hr>
                                            <!-- オプション3 -->
                                            <div class="">
                                                <!-- 入力フィールド -->
                                                {% if form.is_bound %}
                                                    {% if form.option3.errors %}
                                                        {% render_field form.option3 class="form-control is-invalid" %}
                                                        {% for error in form.option3.errors %}
                                                            <div class="invalid-feedback">
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        {% render_field form.option3 class="form-control is-valid" %}
                                                    {% endif %}
                                                {% else %}<!-- 初期表示 -->
                                                    {% render_field form.option3 class="form-control" %}
                                                {% endif %}
                                            </div>
                                        {% endif %}

                                        {% if options_list|is_exist:form.option4.name %}
                                            <hr>
                                            <!-- オプション4 -->
                                            <div class="">
                                                <!-- 入力フィールド -->
                                                {% if form.is_bound %}
                                                    {% if form.option4.errors %}
                                                        {% render_field form.option4 class="form-control is-invalid" %}
                                                        {% for error in form.option4.errors %}
                                                            <div class="invalid-feedback">
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        {% render_field form.option4 class="form-control is-valid" %}
                                                    {% endif %}
                                                {% else %}<!-- 初期表示 -->
                                                    {% render_field form.option4 class="form-control" %}
                                                {% endif %}
                                            </div>
                                        {% endif %}

                                        {% if options_list|is_exist:form.option5.name %}
                                            <hr>
                                            <!-- オプション5 -->
                                            <div class="">
                                                <!-- 入力フィールド -->
                                                {% if form.is_bound %}
                                                    {% if form.option5.errors %}
                                                        {% render_field form.option5 class="form-control is-invalid" %}
                                                        {% for error in form.option5.errors %}
                                                            <div class="invalid-feedback">
                                                                {{ error }}
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        {% render_field form.option5 class="form-control is-valid" %}
                                                    {% endif %}
                                                {% else %}<!-- 初期表示 -->
                                                    {% render_field form.option5 class="form-control" %}
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </th>
                                </tr>
                            </tbody> 
                        </table>
                    </div><!--col6-->

                    <div class="col-6 mb-5">
                        <div class='row'></div>
                        <div class="" id="change_cont1">
                            <h6 class="text-center py-2">現在の契約内容　　　　　　　　　　　　　　　　　　　　　　　　　　　　単位：円</h6>
                            <div class='row mt-2 ml-1'>
                                <div class='col'>
                                    <h6>サービス</h6>
                                </div>
                                <div class='col'>
                                    <h6>{{ contract.service.name }}</h6>
                                </div>
                                <div class='col'></div>
                            </div>
                            <div class='row mt-2 ml-1'>
                                <div class='col'>
                                    <h6>プラン</h6>
                                </div>
                                <div class='col'>
                                    <h6>{{ contract.plan }}</h6>
                                </div>
                                <div class='col'>
                                    <h6 class="text-right pr-3">{{ contract.plan.price|intcomma }}/年</h6>
                                </div>
                            </div>
                            <div class='row mt-2 ml-1' style="height:140px;">
                                <div class='col'>
                                    <h6>オプション</h6>
                                </div>
                                <div class='col'>
                                    {% if contract.option1 %}
                                        <h6>{{ contract.option1.name }}</h6>
                                    {% endif %}
                                    {% if contract.option2 %}
                                        <h6>{{ contract.option2.name }}</h6>
                                    {% endif %}
                                    {% if contract.option3 %}
                                        <h6>{{ contract.option3.name }}</h6>
                                    {% endif %}
                                    {% if contract.option4 %}
                                        <h6>{{ contract.option4.name }}</h6>
                                    {% endif %}
                                    {% if contract.option5 %}
                                        <h6>{{ contract.option5.name }}</h6>
                                    {% endif %}
                                </div>
                                <div class='col'>
                                    {% if contract.option1 %}
                                        <h6 class="text-right pr-3">{{ contract.option1.price|intcomma }}/年</h6>
                                    {% endif %}
                                    {% if contract.option2 %}
                                        <h6 class="text-right pr-3">{{ contract.option2.price|intcomma }}/年</h6>
                                    {% endif %}
                                    {% if contract.option3 %}
                                        <h6 class="text-right pr-3">{{ contract.option3.price|intcomma }}/年</h6>
                                    {% endif %}
                                    {% if contract.option4 %}
                                        <h6 class="text-right pr-3">{{ contract.option4.price|intcomma }}/年</h6>
                                    {% endif %}
                                    {% if contract.option5 %}
                                        <h6 class="text-right pr-3">{{ contract.option5.price|intcomma }}/年</h6>
                                    {% endif %}
                                </div>
                            </div>
                            <hr>
                            <div class='row mt-2 ml-1'>
                                <div class='col'></div>
                                <div class='col'>
                                    <h6 class="text-right pr-3">合計(税抜)</h6>
                                </div><!--colsm-->
                                <div class='col'>
                                    <h6 class="pr-3 text-right gen_total" data-genttl="{{ contract.minor_total }}">{{ contract.minor_total|intcomma }}/年</h6>
                                </div><!--colsm-->
                            </div>
                        </div>
                        <div class="mt-4" id="change_cont2">
                            <h6 class="text-center py-2">選択した契約内容　　　　　　　　　　　　　　　　　　　　　　　　　　　単位：円</h6>
                            <div class='row mt-2 ml-1'>
                                <div class='col'>
                                    <h6>サービス</h6>
                                </div>
                                <div class='col'>
                                    <h6 id="service_name">{{ contract.service.name }}</h6>
                                </div>
                                <div class='col'></div>
                            </div><!--row-->
                            <div class='row mt-2 ml-1'>
                                <div class='col'>
                                    <h6>プラン</h6>
                                </div>
                                <div class='col'>
                                    <h6 id="s_plan"></h6>
                                </div>
                                <div class='col'>
                                    <h6 class="text-right pr-3" id="p_price"></h6>
                                </div>
                            </div><!--row-->
                            <div class='row mt-2 ml-1' style="height:140px;">
                                <div class='col'>
                                    <h6>オプション</h6>
                                </div>
                                <div class='col'>
                                    <h6 id="s_option"></h6>
                                </div>
                                <div class='col'>
                                    <h6 id="o_price"></h6>
                                </div>
                            </div><!--row-->
                            <hr>
                            <div class='row mt-2 ml-1'>
                                <div class='col'></div>
                                <div class='col'>
                                    <h6 class="text-right pr-3">合計(税抜)</h6>
                                </div><!--col-->
                                <div class='col'>
                                    <h6 class="text-right pr-3" id="total_price">0</h6>
                                </div><!--col-->
                            </div><!--row-->
                        </div><!--change_cont2-->
                    </div><!--現在のcol-->
                </div><!--row estimate-->
                <div class="btn-toolbar fixed-bottom p-3">  
                    <div class="row mx-auto">
                        <h5 class="align-middle d-block m-2 tool-text">必須項目を入力して次へ進んでください。</h5>
                        <button type="button" class="btn my-btn-w11 mr-3 my-btn-cancel cancel" data-toggle="modal" data-target="#cancel_modal" onfocus="this.blur();">キャンセル</button>
                        <button type="submit" class="btn my-btn-w11 ml-2 my-btn-accept text-center submit">次へ<span class="next"></span></button>
                    </div>
                </div>
            </form>
        </div><!--card-body-->
    </div><!--card-->



    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">プラン比較表</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="閉じる">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h5 class="pl-3">さらに詳しいサービス紹介サイトは<a href="{% url 'accounts:help' %}" target="_blank">こちら</a>！</h5>
                    <div class="container-fluid">
                        <div class="row mx-auto">
                            <div class="col-4 p-0">
                                <div class="text-center m-1 border-yellow">
                                    <h4 class="bg-yellow py-3 text-white">ライトプラン</h4>
                                    <h5 class="plan-price1"></h5>
                                    <h5 class="text-secondary">利用可能人数：<span class="text-dark plan-user1"></span></h5>
                                    <h5 class="text-secondary">コンテンツ保存可能数：<span class="text-dark plan-contents1"></span></h5>
                                </div><!--border-->
                            </div><!--ライトプラン-->
                            <div class="col-4 p-0">
                                <div class="text-center m-1 border-blue">
                                    <h4 class="bg-blue py-3 text-white">ベーシックプラン</h4>
                                    <h5 class="plan-price2"></h5>
                                    <h5 class="text-secondary">利用可能人数：<span class="text-dark plan-user2"></span></h5>
                                    <h5 class="text-secondary">コンテンツ保存可能数：<span class="text-dark plan-contents2"></span></h5>
                                </div><!--border-->
                            </div><!--ベーシックプラン-->
                            <div class="col-4 p-0">
                                <div class="text-center m-1 border-red">
                                    <h4 class="bg-red py-3 text-white">プレミアムプラン</h4>
                                    <h5 class="plan-price3"></h5>
                                    <h5 class="text-secondary">利用可能人数：<span class="text-dark plan-user3"></span></h5>
                                    <h5 class="text-secondary">コンテンツ保存可能数：<span class="text-dark plan-contents3"></span></h5>
                                </div><!--border-->
                            </div><!--プレミアムプラン-->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
                </div><!-- /.modal-footer -->
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->



    <div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel2">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel2">オプション比較表</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="閉じる">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h5 class="pl-3">さらに詳しいサービス紹介サイトは<a href="{% url 'accounts:help' %}" target="_blank">こちら</a>！</h5>
                    <div class="container-fluid">
                        <div class="p-0">
                            <div class="my-3 p-2 border-option option_info1">
                                <div class="row bg-option py-3 text-option m-0">
                                    <div class="col-4 h4 option_title1 pl-3"></div>
                                    <div class="col-8 h5 option_detail1 mt-1"></div>
                                </div>
                                <div class="row m-0 py-3 text-center text-option">
                                    <div class="col-4">
                                        <h5 class="option-price1_1"></h5>
                                        <h5 class="text-secondary option-1_1"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price1_2"></h5>
                                        <h5 class="text-secondary option-1_2"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price1_3"></h5>
                                        <h5 class="text-secondary option-1_3"></h5>
                                    </div>
                                </div>
                            </div><!--border-->
                            <div class="my-3 p-2 border-option option_info2">
                                <div class="row bg-option py-3 text-option m-0">
                                    <div class="col-4 h4 option_title2 pl-3"></div>
                                    <div class="col-8 h5 option_detail2 mt-1"></div>
                                </div>
                                <div class="row m-0 py-3 text-center text-option">
                                    <div class="col-4">
                                        <h5 class="option-price2_1"></h5>
                                        <h5 class="text-secondary option-2_1"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price2_2"></h5>
                                        <h5 class="text-secondary option-2_2"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price2_3"></h5>
                                        <h5 class="text-secondary option-2_3"></h5>
                                    </div>
                                </div>
                            </div><!--border-->
                            <div class="my-3 p-2 border-option option_info3">
                                <div class="row bg-option py-3 text-option m-0">
                                    <div class="col-4 h4 option_title3 pl-3"></div>
                                    <div class="col-8 h5 option_detail3 mt-1"></div>
                                </div>
                                <div class="row m-0 py-3 text-center text-option">
                                    <div class="col-4">
                                        <h5 class="option-price3_1"></h5>
                                        <h5 class="text-secondary option-3_1"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price3_2"></h5>
                                        <h5 class="text-secondary option-3_2"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price3_3"></h5>
                                        <h5 class="text-secondary option-3_3"></h5>
                                    </div>
                                </div>
                            </div><!--border-->
                            <div class="my-3 p-2 border-option option_info4">
                                <div class="row bg-option py-3 text-option m-0">
                                    <div class="col-4 h4 option_title4 pl-3"></div>
                                    <div class="col-8 h5 option_detail4 mt-1"></div>
                                </div>
                                <div class="row m-0 py-3 text-center text-option">
                                    <div class="col-4">
                                        <h5 class="option-price4_1"></h5>
                                        <h5 class="text-secondary option-4_1"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price4_2"></h5>
                                        <h5 class="text-secondary option-4_2"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price4_3"></h5>
                                        <h5 class="text-secondary option-4_3"></h5>
                                    </div>
                                </div>
                            </div><!--border-->
                            <div class="my-3 p-2 border-option option_info5">
                                <div class="row bg-option py-3 text-option m-0">
                                    <div class="col-4 h4 option_title5 pl-3"></div>
                                    <div class="col-8 h5 option_detail5 mt-1"></div>
                                </div>
                                <div class="row m-0 py-3 text-center text-option">
                                    <div class="col-4">
                                        <h5 class="option-price5_1"></h5>
                                        <h5 class="text-secondary option-5_1"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price5_2"></h5>
                                        <h5 class="text-secondary option-5_2"></h5>
                                    </div>
                                    <div class="col-4">
                                        <h5 class="option-price5_3"></h5>
                                        <h5 class="text-secondary option-5_3"></h5>
                                    </div>
                                </div>
                            </div><!--border-->
                        </div><!--ライトプラン-->
                    </div><!--content-->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
                </div><!-- /.modal-footer -->
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

  <!-- キャンセル確認用 -->
    <div class="modal fade" id="cancel_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <h6>現在の入力した内容は全て破棄されます。</h6>
                </div>
                <div class="modal-footer">
                    <button type="button" class="my-btn my-btn-accept my-btn-sm my-btn-w6" onclick="location.href='{% url 'payment:contract_cancel' %}'">OK</button>
                    <button type="button" class="my-btn my-btn-cancel my-btn-sm my-btn-w6" data-dismiss="modal">戻る</button>
                </div><!-- /.modal-footer -->
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    {% comment %} </div><!--container--> {% endcomment %}
{% endblock %}
{% block extra_js %}
<script src="{% static 'payment/js/option_list.js' %}"></script>

<script>

$(function(){

    // 戻るボタンで戻った時に値が入ったらボタンを有効化
    $('form[data-validate]').each(function(){
        $(this).find(':submit').prop('disabled', !this.checkValidity());
    });
    // 値が入ったらボタンを有効化
    {% comment %} $('form[data-validate]').on('change dp.change', function () {
        $(this).find(':submit').prop('disabled', !this.checkValidity());
    }); {% endcomment %}


    //合計用
    pl_p = 0;//plan_price
    op_p = 0;//option
    to_p = 0;//total
  //プラン表示
    $('[name=plan]').on('change, input, click', function(){
        var id = $(this).attr('id');
        var label = $('label[for="' + id + '"]').text();
        // jQuery.trim()で空白削除
        var name = $.trim(label);
        var price = $('label[for="' + id + '"]').data('price');

        $("#s_plan").text(name);
        $('#p_price').text(price + '/年');
        
        pl_p = Number(price.replace(/[^0-9]/g, ''));

        to_p = pl_p + op_p;
        to_p2 =String(to_p).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');

        if(to_p < 0){
            $('#total_price').text(0 +'/年');
        }else{
            $('#total_price').text(to_p2 +'/年');
        };

        $('#p_price').show();
        $('#total_price').show();

    });

    //オプション表示
    var op_price1 = 0;
    var op_price2 = 0;
    var op_price3 = 0;
    var op_price4 = 0;
    var op_price5 = 0;

    $('[name=option1]').on('change, input', function(){
        $(".opname_1").remove();
        $('.opprice_1').remove();
        op_p = 0;
        var id = $(this).attr('id');
        //オプション名取得
        var label = $('label[for="' + id + '"]').text();
        var name = $.trim(label);

        //値段取得
        if(name !== 'なし'){
            var price = $('label[for="' + id + '"]').data('price');
            var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
            price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
            op_price1 = price2;
            $("#s_option").append('<h6 class="opname_1">' + name + '</h6>');
            $('#o_price').append('<h6 class="opprice_1 text-right pr-3">' + price3 + '/年' + '</h6>');
        }else{
            op_price1 = 0;
        };
    });
    $('[name=option2]').on('change, input', function(){
        $(".opname_2").remove();
        $('.opprice_2').remove();
        op_p = 0;
        var id = $(this).attr('id');
        //オプション名取得
        var label = $('label[for="' + id + '"]').text();
        var name = $.trim(label);

        //値段取得
        if(name !== 'なし'){
            var price = $('label[for="' + id + '"]').data('price');
            var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
            op_price2 = price2;
            price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
            $("#s_option").append('<h6 class="opname_2">' + name + '</h6>');
            $('#o_price').append('<h6 class="opprice_2 text-right pr-3">' + price3 + '/年' + '</h6>');
        }else{
            op_price2 = 0;
        };
    });
    $('[name=option3]').on('change, input', function(){
        $(".opname_3").remove();
        $('.opprice_3').remove();
        op_p = 0;
        var id = $(this).attr('id');
        //オプション名取得
        var label = $('label[for="' + id + '"]').text();
        var name = $.trim(label);

        //値段取得
        if(name !== 'なし'){
            var price = $('label[for="' + id + '"]').data('price');
            var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
            price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
            op_price3 = price2;
            $("#s_option").append('<h6 class="opname_3">' + name + '</h6>');
            $('#o_price').append('<h6 class="opprice_3 text-right pr-3">' + price3 + '/年' + '</h6>');
        }else{
            op_price3 = 0;
        };
    });
    $('[name=option4]').on('change, input', function(){
        $(".opname_4").remove();
        $('.opprice_4').remove();
        op_p = 0;
        var id = $(this).attr('id');
        //オプション名取得
        var label = $('label[for="' + id + '"]').text();
        var name = $.trim(label);

        //値段取得
        if(name !== 'なし'){
            var price = $('label[for="' + id + '"]').data('price');
            var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
            price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
            op_price4 = price2;
            $("#s_option").append('<h6 class="opname_4">' + name + '</h6>');
            $('#o_price').append('<h6 class="opprice_4 text-right pr-3">' + price3 + '/年' + '</h6>');
        }else{
            op_price4 = 0;
        };
    });
    $('[name=option5]').on('change, input', function(){
        $(".opname_5").remove();
        $('.opprice_5').remove();
        op_p = 0;
        var id = $(this).attr('id');
        //オプション名取得
        var label = $('label[for="' + id + '"]').text();
        var name = $.trim(label);
        
        //値段取得
        if(name !== 'なし'){
            var price = $('label[for="' + id + '"]').data('price');
            var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
            price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
            op_price5 = price2;
            $("#s_option").append('<h6 class="opname_5">' + name + '</h6>');
            $('#o_price').append('<h6 class="opprice_5 text-right pr-3">' + price3 + '/年' + '</h6>');
        }else{
            op_price5 = 0;
        };
    });
    $('[name=option1],[name=option2],[name=option3],[name=option4],[name=option5]').on('change, input', function(){
        $('#total_price').empty();

        //値段合計
        op_p = op_price1 + op_price2 + op_price3 + op_price4 +op_price5;
        
        to_p = pl_p + op_p;
        to_p2 =String(to_p).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');

        //0円以下の場合は0にする
        if(to_p < 0){
            $('#total_price').text(0 +'/年');
        }else{
            $('#total_price').text(to_p2 + '/年');
        };

        $("#s_option").show();
        $('#o_price').show();
        $('#total_price').show();

        var gen_total = $('.gen_total').data('genttl');
        if(gen_total<to_p){

            console.log('いまよりたかい')
            $(".min-price").css('visibility', 'hidden');
            //$('.submit').prop('disabled',false);
            $('form[data-validate]').find(':submit').prop('disabled',false);
        }else{
            console.log('いまよりひくい')
            $(".min-price").css('visibility', 'visible');
            $('form[data-validate]').find(':submit').prop('disabled',true);
            


        }
    });

    //戻るボタン用の選択表示
  
    if($('input[name="plan"]:checked')){
        var id = $('input[name="plan"]:checked').attr('id');
        var label = $('label[for="' + id + '"]').text();
        var price = $('label[for="' + id + '"]').data('price');
        pl_p = Number(price.replace(/[^0-9]/g, ''));

        $('#s_plan').text(label);
        $('#p_price').text(price + '/年');

        //オプション
        if($('input[name="option1"]').length&&$('input[name="option1"]:checked').val()){
            var id = $('input[name="option1"]:checked').attr('id');
            var label = $('label[for="' + id + '"]').text();
            if(!label.match(/なし/)){
                var price = $('label[for="' + id + '"]').data('price');
                var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
                price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
                op_price1 = price2;
                $("#s_option").append('<h6 class="opname_1">' + label + '</h6>');
                $('#o_price').append('<h6 class="opprice_1 text-right pr-3">' + price3 + '/年' + '</h6>');
            };
        };
        
        if($('input[name="option2"]').length&&$('input[name="option2"]:checked').val()){
            var id = $('input[name="option2"]:checked').attr('id');
            var label = $('label[for="' + id + '"]').text();
            if(!label.match(/なし/)){
                var price = $('label[for="' + id + '"]').data('price');
                var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
                price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
                op_price2 = price2;
                $("#s_option").append('<h6 class="opname_2">' + label + '</h6>');
                $('#o_price').append('<h6 class="opprice_2 text-right pr-3">' + price3 + '/年' + '</h6>');
            };
        };
        if($('input[name="option3"]').length&&$('input[name="option3"]:checked').val()){
            var id = $('input[name="option3"]:checked').attr('id');
            var label = $('label[for="' + id + '"]').text();
            if(!label.match(/なし/)){
                var price = $('label[for="' + id + '"]').data('price');
                var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
                price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
                op_price3 = price2;
                $("#s_option").append('<h6 class="opname_3">' + label + '</h6>');
                $('#o_price').append('<h6 class="opprice_3 text-right pr-3">' + price3 + '/年' + '</h6>');
            };
        };
        if($('input[name="option4"]').length&&$('input[name="option4"]:checked').val()){
            var id = $('input[name="option4"]:checked').attr('id');
            var label = $('label[for="' + id + '"]').text();
            if(!label.match(/なし/)){
                var price = $('label[for="' + id + '"]').data('price');
                var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
                price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
                op_price4 = price2;
                $("#s_option").append('<h6 class="opname_4">' + label + '</h6>');
                $('#o_price').append('<h6 class="opprice_4 text-right pr-3">' + price3 + '/年' + '</h6>');
            };
        };
        if($('input[name="option5"]').length&&$('input[name="option5"]:checked').val()){
            var id = $('input[name="option5"]:checked').attr('id');
            var label = $('label[for="' + id + '"]').text();
            if(!label.match(/なし/)){
                var price = $('label[for="' + id + '"]').data('price');
                var price2 = Number(price.replace(/[^0-9]/g, ''));//数値化
                price3 =String(price2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
                op_price5 = price2;
                $("#s_option").append('<h6 class="opname_5">' + label + '</h6>');
                $('#o_price').append('<h6 class="opprice_5 text-right pr-3">' + price3 + '/年' + '</h6>');
            };
        };
        //プラン・オプションの合計
        op_p = op_price1 + op_price2 + op_price3 + op_price4 +op_price5;
        to_p = pl_p + op_p;
        to_p2 =String(to_p).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
        console.log('ごうけい',to_p2)
        $('#total_price').text(to_p2 +'/年');
        $('#total_price').show();
    };
});

</script>
{% endblock %}

