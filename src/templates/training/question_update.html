{% extends "common/base.html" %}
{% load i18n static %}
{% load is_exists %}
{% load get_file_id_value %}
{% load zfill %}
{% load get_model_obj %}
{% load get_list %}

<!--  Crispy Form -->
{% load widget_tweaks %}

{% block title %}テストの設問編集画面 | {{ block.super }}{% endblock %}




{% block content %}

    <!-- Bootstrap CSS -->
    {% comment %} <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"> {% endcomment %}
    <link rel="stylesheet" href="{% static 'training/css/bootstrap.min.css' %}">
    {% comment %} <link rel="stylesheet" href="https:///code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"> {% endcomment %}
    <link rel="stylesheet" href="{% static 'common/css/jquery-ui.css' %}">

    <!----- Colorbox ------>
    {% comment %} <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-colorbox@1.6.4/example2/colorbox.css" /> {% endcomment %}


    <!-- CSSの読み込み -->

    <style>

        .container {
            max-width: 1140px;
            max-height: 1130px;

            min-width: 1140px;
            min-height: 1130px;
        }

        /*---------------------------------

        for Header
        
        ---------------------------------*/
        
        body {
            font-size: 12px;
            font-family: 'Avenir','Helvetica Neue','Helvetica','Arial','Hiragino Sans','ヒラギノ角ゴシック','YuGothic','Yu Gothic','メイリオ', 'Meiryo','ＭＳ Ｐゴシック','MS PGothic'
        }
        
        .navbar-expand .navbar-nav .nav-link {
            padding: 0;
            font-size: 1.5rem;
        }
        
        .navbar-nav .nav-item .nav-link {
            color: #fff;
        }
        
        .menu_title_size {
            font-size: 1.4rem;
        }


        /*---------------------------------
    
            背景色
    
        ---------------------------------*/
    
        #wrapper {
            background-color: #f1f1f1;
        }
    
        /*---------------------------------
    
            タイトル、サブタイトル
    
        ---------------------------------*/
    
        .cp_h1title{
            position: relative;
            overflow: hidden;
            padding-top: 50px;
            padding-bottom: 10px;
            text-align: left;
        }
        .cp_h1title::before{
            content: "";
            position: absolute;
            bottom: 0;
        }
        .cp_h1title:before{
            border-bottom: 4px solid #4a849a;
            width: 100%;
        }
    
        .cp_p_title {
            text-align: left;
            font-size: 15px;
        }
    
    
        /*---------------------------------
    
            ボタン
    
        ---------------------------------*/
    
        .my-btn-gray-1 {
            color: #595959 !important;
            background: #adadad;
        }
    
        .btn-grp {
            margin: 80px;
        }
    
    
        /*---------------------------------
    
            フォーム
    
        ---------------------------------*/
    
        .card_form {
            background-color: #fff;
            border: 1px solid #e8e8e8;
            box-shadow: 0 1px 4px 0 rgb(0 0 0 / 14%);
            border-radius: 0;
        }
    
        .card-body {
            color: #554738;
            padding: 65px;
            font-size: 16px;
            line-height: 28px;
        }
    
        /*---------------------------------
    
            必須、任意ラベル
    
        ---------------------------------*/
        .require_label {
            color: #595959;
            font-size: 1rem;
            margin-top: 3px;
        }
    
        .option_label {
            color: #595959;
            font-size: 1rem;
            margin-top: 3px;
        }
    
        .required_box {
            width: 100%;
            display: -webkit-inline-box;
            /*display: block;*/
            position: relative;
        }
    
    
        .option_box {
            width: 100%;
            display: -webkit-inline-box;
            position: relative;
        }
    
    
        .required_box::after {
            color: #ffffff;
            font-size: 0.5rem;
            position: absolute;
            left: 115px;
            background-color: red;
            border-radius: 3px;
            padding: 0px 10px;
            white-space: nowrap;
            margin-left: 10px;
            content: "必須";
    
        }
    
        .option_box::after {
            color: #ffffff;
            font-size: 0.5rem;
            position: absolute;
            left: 125px;
            {% comment %} right: 3px;
            top: 7px; {% endcomment %}
            background-color: #7d8285;
            border-radius: 3px;
            padding: 0px 10px;
            white-space: nowrap;
            margin-left: 10px;
            content: "任意";
        }
    
        .name_error_message {
            text-align: left;
            color: red;
    
        }
    
        span.error {
            color: red;
            display: block;
            text-align: left;
        }
    
    
    
    
        /*---------------------------------
    
        パーツを追加するのボタン
    
        ---------------------------------*/
    
        .fas_button_parts_add:focus {
            outline: none;/* ボタンクリック時の枠線を消す */
        }
    
        .fas_button_parts_add{
            border: none;
            padding: 0 404px;
            height: 55px;
            line-height: 1;
            background-color: #FFFFFF;
            color: #7cb1ec;
            border: 2px solid #7cb1ec;
            border-radius: 5px;
            font-size: 16px;
            margin-top: 10px;
            {% comment %} outline: none; {% endcomment %}
        }
        .fas_button_parts_add:before{
            font-style: normal;
            font-variant: normal;
            text-rendering: auto;
            -webkit-font-smoothing: antialiased;
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            content: '\f055';
            margin-right: 5px;
        }
    
    
    
        /*---------------------------------
    
        回答項目・正解
    
        ---------------------------------*/
    
        .sb-example-1 .search {
            width: 100%;
            padding-bottom: 10px;
            position: relative;
            display: flex;
            align-items :center;
        }
    
        .sb-example-1 .searchTerm {
            display: inline-block; /* なくても大丈夫だけど、念の為 */
            position: relative;    /* 基準値とする */
    
            width: 100%;
            border: 2px solid #cbcbcb;
            border-left: none;
            padding: 5px;
            border-radius: 0 5px 5px 0;
            outline: none;
            color: #343a40;
        }
    
        .sb-example-1 .searchButton {
            width: 70px;
            height: 42px;
            border: 1px solid #cbcbcb;
            background: #cbcbcb;
            text-align: center;
            color: #fff;
            border-radius: 5px 0 0 5px;
            cursor: pointer;
            font-size: 32px;
        }
    
    
        /*---------------------------------
    
        textarea
    
        ---------------------------------*/
        textarea {
            resize: none;/* 拡大・縮小を禁止 */
            width: 100%;
            height: 200px;
        }
    
    
        /*---------------------------------
    
        画像アップロード
    
        ---------------------------------*/
        .dropzone_upload_icon {
            color: #999999;
        }

        .border {
            width: 113%;
            margin: 50px 0 50px 0;
            margin-left: -65px;/* 左側に線を伸ばす */
        }

        {% comment %} .cp_ipselect {
            overflow: hidden;
            width: 100%;
            text-align: center;
        }
        .cp_ipselect select {
            width: 100%;
            padding-right: 1em;
            cursor: pointer;
            text-indent: 0.01px;
            text-overflow: ellipsis;
            border: none;
            outline: none;
            background: transparent;
            background-image: none;
            box-shadow: none;
            -webkit-appearance: none;
            appearance: none;
        }
        .cp_ipselect select::-ms-expand {
            display: none;
        }
        .cp_ipselect.cp_sl01 {
            position: relative;
            border: 1px solid #bbbbbb;
            border-radius: 2px;
            background: #ffffff;
        }
        .cp_ipselect.cp_sl01::before {
            position: absolute;
            top: 20px;
            right: 0.9em;
            width: 0;
            height: 0;
            padding: 0;
            content: '';
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #666666;
            pointer-events: none;
        }
        .cp_ipselect.cp_sl01 select {
            padding: 8px 38px 8px 8px;
            color: #666666;
        } {% endcomment %}
    
    
    
        /*---------------------------------
    
        for Dropzone previews
    
        ---------------------------------*/

        html, body {
            height: 100%;
        }
        #actions {
            margin: 2em 0;
        }
    
        .expiration_start_date,
        .expiration_end_date {
            font-size: 1rem;
            margin-right: 10px
        }
    
        .step2 btn, .btn-sm{
            padding: .1rem .4rem;
            font-size: 0.8rem;
            border-color: #808080;
        }
    
        /* Mimic table appearance */
        div.table {
            display: table;
            table-layout: fixed;
        }
        div.table .file-row {
            display: table-row;
        }
        div.table .file-row > div {
            display: table-cell;
            border-top: 1px solid #ddd;
            padding: 7px 5px;
            vertical-align: middle;
        }
    
        div.table .file-row > .icon_colum {
            width: 30px;
        }
    
        .icon_colum > .icon {
            font-size: 1.5rem;
            margin: auto;
        }
    
        .icon_colum > .xls {
            color: #3A7C19;
        }
    
        .icon_colum > .doc {
            color: #2B569A;
        }
    
        .icon_colum > .ppt {
            color: #D24627;
        }
    
        .icon_colum > .csv {
            color: #3A7C19;
        }
    
        .icon_colum > .pdf {
            color: #EA412C;
        }
    
        div.table .file-row > .check_colum {
            width: 36px;
        }
    
        div.table .file-row > .size_colum {
            width: 70px;
        }
    
        div.table .file-row > .progress_colum {
            width: 190px;
        }
    
        div.table .file-row > .button_colum {
            width: 80px;
        }
    
        div.table .preview-text{
            margin: auto;
        }
    
        div.table .preview-button {
            text-align: right;
        }
    
        div.table .preview-button .btn-secondary.disabled, .btn-secondary:disabled {
            pointer-events: none;
            opacity: 0.3;
        }
    
        div.table .preview-button .btn {
            font-size: 0.5rem;
            padding: 1px 2px;
        }
    
    
        div.table .file-row:nth-child(odd) {
            background: #f9f9f9;
        }
    
    
        /* The total progress gets shown by event listeners */
        #total-progress {
            opacity: 0;
            -webkit-transition: opacity 0.3s linear;
            transition: opacity 0.3s linear;
        }

        /* Hide the progress bar when finished */
        #previews .file-row.dz-success .progress {
            opacity: 0;
            -webkit-transition: opacity 0.3s linear;
            transition: opacity 0.3s linear;
        }

        /* Hide the delete button initially */
        #previews .file-row .delete {
            display: none;
        }

        /* Hide the start and cancel buttons and show the delete button */

        #previews .file-row.dz-success .start {
            display: none;
        }
        #previews .file-row.dz-success .cancel,
        #previews .file-row.dz-success .delete {
            display: block;
        }


        /*---------------------------------

        削除ボタン

        ---------------------------------*/

        .fa-minus-circle {
            font-size: 20px;
            margin-left: 10px;
            color: #ff6e6e;
        }

        /*---------------------------------

        バリデーションエラー
    
        ---------------------------------*/
    
        span.error {
            color: red;
            display: block;
            text-align: left;
        }
    
        .number_field {
            width: 100%;
            height: 45px;
        }

    </style>





    <div class="container">

        {% for parts in test_parts %}

            <div>
                <h3 class="cp_h1title">テストの設問編集画面</h3>
                <p class="cp_p_title m-0 pt-2">・【必須】がついている項目は必須です。必ず入力してください。</p>
                <p class="cp_p_title m-0">・選択項目を入力した状態で回答タイプを再選択する場合、選択項目・正解に入力した内容は初期化されます。</p>
                <p class="cp_p_title m-0 pb-4">・画像の推奨サイズは縦4000ピクセル以上、横2000ピクセル以上です。それ以下のサイズの画像をアップロードする場合、表示する際にレイアウトが崩れる可能性がありますのでご注意ください。</p>

                {% comment %} <p class="cp_p_title m-0 pb-4">・【受講の任意/必須】という項目ではトレーニングの受講を必須とするかどうかを設定します。</p> {% endcomment %}

                <!-- 存在確認のエラー -->
                <div>
                    {% for error in form.non_field_errors %}
                    <p class="name_error_message">
                        {{ error }}
                    </p>
                    {% endfor %}
                </div>

            </div>


            <div class="card p-30">
                <div class="d-flex flex-column card_header">

                    <div class="d-none d-inline-block mt-3 ml-4 mb-0">
                        <div class="test_title_size">{{parts.title_detail}}</div>
                    </div>
                    <div class="d-none d-inline-block mt-0 ml-4 mb-3">
                        <div class="test_desc_size">{{parts.description_detail|safe}}</div>
                    </div>

                </div>
            </div>


            <div class="my-div-style w-100">

                <form action="" method="POST" id="question_update_form">

                    {% for hidden in form.hidden_fields %}
                        {{ hidden }}
                    {% endfor %}

                    <div class="card_form mt-4">

                        <div class="card-body">

                            {% comment %} {{ formset.management_form }}<!-- こっちにしないと回答欄が追加できなかった --> {% endcomment %}
                            {{ form.formset.management_form }}
                            {% csrf_token %}

                            <div>
                                <div class="required_box">
                                    <div class="label require_label pb-2" style="font-weight: bold;">設問内容</div>
                                </div>

                                {% render_field form.text class="form-control is_primary" placeholder="500文字以内で入力してください。" %}

                            </div>

                            <hr class="border">

                            <div>
                                <div class="required_box">
                                    <div class="label require_label pb-2" style="font-weight: bold;">回答タイプ</div>
                                </div>

                                <div class="cp_ipselect cp_sl01">
                                    {% render_field form.is_multiple %}
                                </div>

                            </div>

                            <hr class="border">

                            {% comment %} <div>
                                <div class="option_box">
                                    <div class="label require_label pb-2" style="font-weight: bold;">回答数</div>
                                </div>

                                <div class="">
                                    {% render_field form.number_of_answers class="number_field" min="0" max="100"%}
                                </div>

                            </div>

                            <hr class="border"> {% endcomment %}

                            <div>

                                <div class="required_box">
                                    <div class="label require_label pb-2" style="font-weight: bold;">選択項目・正解</div>
                                </div>

                                {% comment %} {{form.formset.as_p}} {% endcomment %}

                                <div class="choice_area sb-example-1">

                                    {% for form in form.formset %}

                                        <div class="search">

                                            <!-- 正解 -->
                                            <div class="searchButton">{{form.is_correct}}</div>

                                            <!-- 入力欄 -->
                                            <div class="text_field">{{form.text}}</div>

                                            <!-- 削除アイコン -->
                                            <div class="remove_field">
                                                <a href="javascript:void(0);" class="remove_button" id="{{form.id.value}}">
                                                    <i class="fas fa-minus-circle"></i>
                                                </a>
                                            </div>
                                            <!-- id ※これがないと値が更新されない -->
                                            {% comment %} {{form.id}} {% endcomment %}

                                            {% render_field form.id data-target="form_id" %}

                                        </div>

                                        <!-- [{'id': ['正しく選択してください。選択したものは候補にありません。']}, {}, {}, {}, {}] -->
                                        {% comment %} {% render_field form.id data-target="form_id" %} {% endcomment %}

                                    {% endfor %}

                                    <!-- 記述式 -->
                                    <div class="text_area" style="display:none">
                                        {% comment %} <textarea name="choice_set-0-text" id="id_choice_set-0-text" value="" class="searchTerm text_d"  placeholder="120文字以内で入力してください。" data-target="hoge" disabled></textarea> {% endcomment %}
                                        <textarea name="choice_set-0-text" id="id_choice_set-0-text" value="" class="text_d"  placeholder="120文字以内で入力してください。" data-target="hoge" disabled></textarea>
                                    </div>

                                </div>

                            </div>

                            <!-- 回答欄追加ボタン -->
                            <button type="button" class="fas_button_parts_add btn-tag--favorite" id="add_more" data-toggle="modal" data-pk="">回答項目を追加する</button>

                            <hr class="border">


                            <!-- 画像アップロード -->
                            <div class="">
                                <div class="option_box">
                                    <div class="label option_label pb-2" style="font-weight: bold;">画像アップロード</div>
                                </div>

                                <!-- ポスターのドラッグアンドドロップ部 -->

                                <div id="image_Dropzone" class="dropzone" name="poster">

                                    <div class="fallback">
                                        <input name="poster" type="file"/>
                                    </div>

                                </div>

                                <!-- ドラッグアンドドロップしたファイルのリスト表示部 -->
                                <div class="table table-striped" class="files" id="previews">

                                    <div id="template" class="file-row">

                                        <!-- This is used as the file preview template -->
                                        <div class="icon_colum">
                                            <div class="preview"></div>
                                        </div>

                                        <div class="name_colum">
                                            <span class="name preview-text" data-dz-name></span>
                                            <strong class="error text-danger" data-dz-errormessage></strong>
                                        </div>

                                        <div class="size_colum">
                                            <span class="size preview-text" data-dz-size></span>
                                        </div>

                                        <div class="preview-button preview-text button_colum">
                                            <button data-dz-remove class="btn btn-secondary my-btn-w3 cancel">
                                                <!-- <i class="glyphicon glyphicon-ban-circle"></i> -->
                                                <span class="preview-button-text">取消</span>
                                            </button>
                                        </div>

                                    </div>

                                </div>

                                <div id="validation-error-poster"></div>

                            </div>

                        </div><!-- card-body -->
                    </div>

                    <!-- ボタン -->
                    <div class="d-flex justify-content-center btn-grp">

                        <!-- トレーニング編集ページへ遷移 -->
                        {% comment %} <a href="{{request.META.HTTP_REFERER}}">
                            <button type="button" class="my-btn my-btn-gray-1 my-btn-w12 mr-3"><span class="my_btn_text">戻る</span></button>
                        </a> {% endcomment %}

                        <button type="button" class="my-btn my-btn-gray-1 my-btn-w12 mr-3 return_btn" onclick="javascript:history.back();">
                            戻る
                        </button>

                        <button type="button" class="my-btn my-btn-gray-1 my-btn-w12 mr-3 return_btn_modal" data-target="#exampleModal" data-toggle="modal">
                            戻る
                        </button>

                        <button type="submit" id="question_update_btn" class="my-btn my-btn-egypt-1 my-btn-w12" disabled><span class="my_btn_text">変更</span></button>

                    </div>


                </form>


                {% for choice in question.choice_set.all %}
                    <!-- ※data-choice_textを追加　ラジオボタンに影響がある可能性あり -->
                    {% comment %} <div hidden class="choice_value" data-choide_id={{choice.id}} data-choice_is_correct_value={{choice.is_correct}}></div> {% endcomment %}
                    <div hidden class="choice_value" data-choide_id={{choice.id}} data-choice_is_correct_value={{choice.is_correct}} data-choice_text={{choice.text}} ></div>
                {% endfor %}

            </div>

        {% endfor %}


    </div>


    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">ナビゲーションの確認</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h6>
                        入力内容は保存されません。よろしいですか？<br>
                        このページから移動してもよろしいですか？
                    </h6>
                </div>
                <div class="modal-footer justify-content-center">
                    <a href="{{request.META.HTTP_REFERER}}">
                        <button type="button" class="my-btn my-btn-gray-1 my-btn-w12 mr-3"><span class="my_btn_text">このページを離れる</span></button>
                    </a>
                    <button type="button" class="my-btn my-btn-egypt-1 my-btn-w12" data-dismiss="modal">このページにとどまる</button>
                </div>
            </div>
        </div>
    </div>



{% endblock %}

{% block extra_js %}

<script>
    /////////////////////////////
    // リロード時にトップにくるようにする
    /////////////////////////////
    $(function() {
        $('html,body').scrollTop(0)
    });
</script>


<script>
    /////////////////////////////
    // 設問内容にカーソルが当たった状態で
    //　ページを表示する
    /////////////////////////////

    $("#id_text").focus()

</script>


<script>
    /////////////////////////////
    // 改行を禁止にする
    /////////////////////////////

    $(function () {
        $('.searchTerm')
            // cancelEnterとついたクラスにkeydownイベントを付与
            .on('keydown', function (e) {
                // e.key == 'Enter'でエンターキーが押された場合の条件を設定
                if (e.key == 'Enter') {
                    // 何もせずに処理を終える
                    return false;
                }
            })
    });
</script>


<script>
    /////////////////////////////
    // 入力されたら戻るボタンを
    // 押したときにモーダル表示
    /////////////////////////////

    // -----------------
    // form全体のバリデーションチェック
    // -----------------
    function validateForm(id) {

        var valid = $(id).validate().checkForm();
        console.log("valid", valid)

        return valid

    }

    // 確認ダイアログボタン非表示
    $(".return_btn_modal").fadeOut();

	setTimeout(function(){
		// 遅延実行したい処理
        var $form = $('form'),
        origForm = $form.serialize();

        $('form')
        .on('change input', function() {

            console.log("serializeArray", $form.serializeArray())

            if(validateForm('#question_update_form')){
                // フォームに変更があった場合
                if ($form.serialize() !== origForm){
                    $(".return_btn_modal").css("display", "block");
                    $(".return_btn").css("display", "none");

                    $("#question_update_btn").prop('disabled', false);// ボタンを有効にする
                    console.log("不一致です");
                }else{
                    $(".return_btn").css("display", "block");
                    $(".return_btn_modal").css("display", "none");

                    $("#question_update_btn").prop('disabled', true);// ボタンを無効にする
                    console.log("一致です");
                }
            }else{
                $("#question_update_btn").prop('disabled', true);// ボタンを無効にする
            }
        });
	}, 3000 );

</script>


<script>
$(document).ready(function() {

    // -----------------
    // validateのoption作成
    // -----------------
    $('#question_update_form').validate({

        errorElement: "span",// labelがspanにかわる

        //入力欄別にルールを作成　※nameを指定すること
        rules:{
            text:{
                required: true,
                maxlength: 500,
            },
            is_multiple:{
                required: true,
            },

        },
        // エラーメッセージを設定
        messages:{
            text:{
                required: '設問内容の入力は必須です。',
                maxlength: '設問内容は500文字以内で入力してください。',
            },
            is_multiple:{
                required: '回答タイプの選択は必須です。',
            },

        },

        errorPlacement: function (error, element) {

            // 指定タグの中に出したい場合はappendTo()

            if (element.attr("name") == "text" ) {
                element.parent().append(error)

            } else if (element.attr("name") == "is_multiple" ) {
                element.parent().parent().append(error)
            }

        }


    });

    // -----------------
    // validate 変更
    // -----------------
    $("#question_update_form").on('keyup change', function(event) {

        // validateForm(): フォームのバリデーションを担当する
        //validateForm('#question_update_form');

    });

    {% comment %} function validateForm(id) {

        var valid = $(id).validate().checkForm();
        console.log("valid", valid)

        if (valid) {
            $('#question_update_btn').prop('disabled', false);// enables button
        } else {
            $('#question_update_btn').prop('disabled', true);// disables button
        }
    } {% endcomment %}

    // formを送信するときに解答にチェックがついているか確認
    $('#question_update_form').submit(function(e){

        // selectボックスの値を取得
        var value = $('input[name=is_multiple]:checked').val();
        console.log("value : ", value)

        // チェックボックスの値を取得
        var check_count = $('input[type=checkbox]:checked').length;
        console.log("check_count", check_count)// 0

        // ラジオボタンの値を取得
        var check_value = $("input[type=radio]:checked").not('.form-check-input').prop('checked');
        console.log("check_value", check_value)// true or undefined

        // テキストエリアの値を取得
        var check_text = $(".text_d").val();
        console.log("check_text", check_text)

        // inputの値を取得
        var flag = false;
        $('input[type="text"]').each(function() {
            // 一つでもinputに値が入力されていればtrue
            flag = $(this).val().length > 0;
            return !flag;// true
        });

        console.log("flag", flag)


        // ラジオボタン
        if (value == '1') {
            console.log("ラジオボタン")
            if (check_count == 0 && !check_value){
                $('.choice_area').after('<span id="id_text-error" class="error">正解の選択肢にチェックを入れてください。</span>');
                return false;
            }

            // inputの値を取得
            if (!flag){
                console.log("aaaa")
                $('.choice_area').after('<span id="id_text-error" class="error">回答の入力は必須です。</span>');
                return false;
            } else {
                console.log("bbbb")
            }

        // チェックボックス
        }else if(value == '2'){
            console.log("チェックボックス")
            if (check_count == 0 && !check_value){
                $('.choice_area').after('<span id="id_text-error" class="error">正解の選択肢にチェックを入れてください。</span>');
                return false;
            }

            // inputの値を取得
            if (!flag){
                console.log("aaaa")
                $('.choice_area').after('<span id="id_text-error" class="error">回答の入力は必須です。</span>');
                return false;
            } else {
                console.log("bbbb")
            }

        // 記述式
        }else{
            console.log("記述式")
            if (check_text.length === 0){
                $('.choice_area').after('<span id="id_text-error" class="error">回答の入力は必須です。</span>');
                return false;
            }

        }

    });


});
</script>


{% comment %} <script>
    // -----------------
    // form全体のバリデーションチェック
    // -----------------
    function validateForm(id) {

        var valid = $(id).validate().checkForm();
        console.log("valid", valid)

        return valid

    }

    // -----------------
    // .serialize()でformのデータを保存して
    // 変更ごとに値が一致するかどうかを確認する
    // -----------------

    $(function(){

        $('form')
        .each(function(){
            $(this).data('serialized', $(this).serialize())
        })
        .on('change dp.change input', function(){

            // formの入力が正しく行われている場合
            if(validateForm('#question_update_form')){

                // 入力前の値と入力後の値が一致した場合
                if($(this).serialize() == $(this).data('serialized')){

                    //console.log("入力前の値と入力後の値が一致")

                    // ファイルがアップロードされた場合
                    //if(file_changed || add_more_flg || choice_delete_flg){
                    //if(add_more_flg || choice_delete_flg){
                    if(file_changed){
                        console.log("file_changed/add_more_flgはtrueです")

                        $(this)
                        .find('input:submit, button:submit')
                            .prop('disabled', false)// ボタンを有効にする
                        ;

                    }else{
                        //console.log("file_changedはfalseです")

                        $(this)
                        .find('input:submit, button:submit')
                            .prop('disabled', true)// ボタンを無効にする
                        ;
                    }

                }else{
                    //console.log("入力前の値と入力後の値が不一致")

                    $(this)
                    .find('input:submit, button:submit')
                        .prop('disabled', false)// ボタンを有効にする
                    ;
                }

            // 正しく行われていない場合
            }else{
                //console.log("aaaaaaformの入力が正しく行われていない")
                $('#question_update_btn').prop('disabled', true);// ボタンを無効にする
            }

        })
        .find('input:submit, button:submit')
            .prop('disabled', true);

    })

</script> {% endcomment %}


<script>
    /////////////////////////////
    // 選択項目の表示、非表示    //
    /////////////////////////////


    //form-TOTAL_FORMS	送信したフォームの合計数
    //form-INITIAL_FORMS	初期値が設定されたフォームの合計数
    //form-MIN_NUM_FORMS	フォームの最小数
    //form-MAX_NUM_FORMS	フォームの最大数（max_numで指定した数字）


    $(function() {

        var total_INITIAL_FORMS = $('#id_choice_set-INITIAL_FORMS');

        var INITIAL_FORMS_Count = parseInt(total_INITIAL_FORMS.val());
        console.log("INITIAL_FORMS_Count", INITIAL_FORMS_Count);


        var choice_set_TOTAL_FORMS = $('#id_choice_set-TOTAL_FORMS');
        var TOTAL_FORMS_Count = parseInt(choice_set_TOTAL_FORMS.val());
        console.log("TOTAL_FORMS_Count", TOTAL_FORMS_Count);

        {% comment %} setTimeout(function(){
            $('#id_choice_set-TOTAL_FORMS').val(INITIAL_FORMS_Count);
        },1); {% endcomment %}





        var fuga = $('input[data-target="fuga"]');
        //console.log(fuga);

        var hoge = $('#id_choice_set-1-text.searchTerm');

        // 一番目と二番目の削除ボタンを削除できないようにする
        $(".remove_button").eq(0).css({"pointer-events":"none", "opacity":"0.5"});
        $(".remove_button").eq(1).css({"pointer-events":"none", "opacity":"0.5"});

        // テキストボックスの値をクリアする
        var clearInputInfo = function () {
            $('input.searchTerm').val('');
            //$('input.icon_correct').prop('checked', false);
        };
        // テキストエリアの値をクリアする
        var clearTextarea = function () {
            $('.text_d').val('');
        };
        // ラジオボタンのチェックを外す
        var clearRadio = function () {
            $("input[type=radio]:checked").not('.form-check-input').prop('checked', false);
        };
        // チェックボックスのチェックを外す
        var clearCheckbox = function () {
            $("input[type=checkbox]:checked").prop('checked', false);
        };


        var totalManageElement_Textarea = function () {
            // 回答項目の数を一つだけ残すように設定する
            var totalManageElement = $('#id_choice_set-TOTAL_FORMS');
            //var initialFormsElement = $('#id_choice_set-INITIAL_FORMS');

            var currentFileCount = parseInt(totalManageElement.val());
            console.log("currentFileCount 回答項目数", currentFileCount)

            //var initialFormsCount = parseInt(initialFormsElement.val());
            //console.log("initialFormsCount カウント", initialFormsCount)

            currentFileCount = 1;
            //initialFormsCount = 1;

            totalManageElement.attr('value', currentFileCount);
            //initialFormsElement.attr('value', initialFormsCount);
        };


        var totalManageElement_Input = function () {
            // 回答項目の数を一つだけ残すように設定する
            var totalManageElement = $('#id_choice_set-TOTAL_FORMS');
            //var initialFormsElement = $('#id_choice_set-INITIAL_FORMS');

            var currentFileCount = parseInt(totalManageElement.val());
            console.log("currentFileCount 回答項目数", currentFileCount)

            //var initialFormsCount = parseInt(initialFormsElement.val());
            //console.log("initialFormsCount カウント", initialFormsCount)

            currentFileCount = 4;
            //initialFormsCount = 0;

            totalManageElement.attr('value', currentFileCount);
            //initialFormsElement.attr('value', initialFormsCount);
        };




        // 値の取得
        //var selected_value = $('option:selected').val();
        var selected_value = $('input[name="is_multiple"]:checked').val();

        // 結果の出力
        console.log("セレクトボックス：", selected_value)

        // 選択された値ごとに選択肢の表示を切り替える
        switch (selected_value){

            case '1':
                console.log('ラジオボタンです');

                $('input[type="checkbox"]').each(function() {
                    var rep = $('<input type="radio">');

                    rep.attr("value", this.value);
                    rep.attr("name", this.name);
                    //rep.attr("name", "choice_set-is_correct");
                    rep.attr("id", this.id);
                    //rep.attr("id", "choice_set-0-is_correct");
                    rep.attr("class", this.class);
                    rep.attr("data-target", "fuga");
                    rep.attr("style", "display: ");

                    $(this).replaceWith(rep);
                });

                // 表示
                $('.search').show();
                $('.fas_button_parts_add').show();

                // 非表示
                $('.text_area').hide();

                // disabledを付与する
                $('.text_d').prop('disabled', true);


                // テキストボックスの値をクリアする
                clearTextarea();
                //clearRadio();
                //clearCheckbox();


                // 回答項目の数を一つだけ残すように設定する
                //totalManageElement_Input();



                // input要素にreadonlyを付与する
                //$('input.searchTerm').attr('readonly',false);
                $('input.searchTerm').attr('disabled',false);
                //$('input[data-target="fuga"]').attr('disabled',false);

                // Is_correctの✓を外す
                //$('#id_choice_set-0-is_correct').prop('checked', false)

                $('.sb-example-1 .searchTerm').css({'border-left':'none', 'border-radius':'0 5px 5px 0', 'width':'100%', 'height':''});

                //画面読み込み時にラジオボタンにチェックを付ける
                choice_list = []
                // HTML内にhiddenで描画しているis_correctの値を取得してオブジェクト化
                $('.choice_value').each(function() {
                    choice_json = {}
                    choice_json.id = $(this).data('choide_id');
                    choice_json.is_correct = $(this).data('choice_is_correct_value');
                    choice_list.push(choice_json)
                })

                // オブジェクトをソート(昇順)
                let sorted_choice_list = choice_list.sort(function(a, b) {
                    return (a.id < b.id) ? -1 : 1;  //オブジェクトの昇順ソート
                });

                //　ループしてis_correctがTrueの場合、そのindex値で該当のselector(id)を生成してチェックする
                sorted_choice_list.forEach((value, index , array)  => {

                    console.log("value", value)

                    if (value['is_correct'] == "True") {
                        $("#id_choice_set-" + index + "-is_correct").prop('checked', true);

                    }

                });

                //擬似的にラジオボタンの動きを再現
                $('input[type="radio"]').not('.form-check-input').on("input", function() {
                //$('input[type="radio"]').on("input", function() {
                    $('input[type="radio"]').not('.form-check-input').each(function() {
                    //$('input[type="radio"]').each(function() {
                        // リセット
                        $(this).prop('checked', false);
                    })

                    $(this).prop('checked', true);
                });

                break;

            case '2':
                console.log('チェックボックスです');

                // ステップ2表示
                $('.choice_area').show();
                $('.fas_button_parts_add').show();

                // 非表示
                $('.texit_area').hide();

                // テキストボックスの値をクリアする
                clearTextarea();
                //clearRadio();
                //clearCheckbox();

                // 回答項目の数を一つだけ残すように設定する
                //totalManageElement_Input();






                // input要素にreadonlyを付与する
                //$('input.searchTerm').attr('readonly',false);
                $('input.searchTerm').attr('disabled',false);
                //$('input[data-target="fuga"]').attr('disabled',false);

                $('input[type="radio"]').not('.form-check-input').each(function() {
                //$('input[type="radio"]').each(function() {
                    var rep = $('<input type="checkbox">');

                    rep.attr("value", this.value);
                    rep.attr("name", this.name);
                    rep.attr("id", this.id);
                    rep.attr("class", this.class);
                    rep.attr("data-target", "fuga");
                    rep.attr("style", "display: ");

                    $(this).replaceWith(rep);
                });

                // 表示
                $('.search').show();
                $('.fas_button_parts_add').show();

                // 非表示
                $('.text_area').hide();

                // disabledを付与する
                $('.text_d').prop('disabled', true);

                // Is_correctの✓を外す
                //$('#id_choice_set-0-is_correct').prop('checked', false)

                $('.sb-example-1 .searchTerm').css({'border-left':'none', 'border-radius':'0 5px 5px 0', 'width':'100%', 'height':''});


                break;

            case '3':
                console.log('記述式(完全一致)です');

                // テキストボックスの値をクリアする
                clearInputInfo();
                clearRadio();
                clearCheckbox();


                // 回答項目の数を一つだけ残すように設定する
                //totalManageElement_Textarea();


                // input要素にreadonlyを付与する
                //$('input.searchTerm').attr('readonly',true);
                $('input.searchTerm').attr('disabled',true);
                //$('input[data-target="fuga"]').attr('disabled',true);

                // 表示
                $('.text_area').show()

                // 非表示
                $('.search').hide();// 正解
                $('.fas_button_parts_add').hide();// 追加ボタン

                // disabledを外す処理
                $('.text_d').prop('disabled', false);

                $('.sb-example-1 .searchTerm').css({'border-left':'2px solid #cbcbcb', 'border-radius':'5px 5px', 'width':'980px', 'height':'80px'});

                // textareaに値を設定
                choice_text = $(".choice_value").data('choice_text');
                console.log("aaa", choice_text)
                $('textarea[name="choice_set-0-text"]').val(choice_text);


                break;

            case '4':
                console.log('記述式(部分一致)です');

                // テキストボックスの値をクリアする
                clearInputInfo();
                clearRadio();
                clearCheckbox();



                // 回答項目の数を一つだけ残すように設定する
                //totalManageElement_Textarea();






                // input要素にreadonlyを付与する
                //$('input.searchTerm').attr('readonly',true);
                $('input.searchTerm').attr('disabled',true);
                //$('input[data-target="fuga"]').attr('disabled',true);


                // 表示
                $('.text_area').show()

                // 非表示
                $('.search').hide();// 正解, 削除アイコン

                $('.fas_button_parts_add').hide();// 追加ボタン

                // disabledを外す処理
                $('.text_d').prop('disabled', false);

                $('.sb-example-1 .searchTerm').css({'border-left':'2px solid #cbcbcb', 'border-radius':'5px 5px', 'width':'980px', 'height':'80px'});

                // textareaに値を設定
                choice_text = $(".choice_value").data('choice_text');
                console.log("aaa", choice_text)
                $('textarea[name="choice_set-0-text"]').val(choice_text);


                break;

            default:
                console.log('その他です');

        }































        // 回答タイプの変更に応じて解答が変わる

        // ページ読み込みと同時にchangeイベントを実行する
        //$('select').on("change", function() {
        $('input[name="is_multiple"]').on("change", function() {

            // 値の取得
            //var selected_value = $('option:selected').val();
            //var selected_value = $(this).val();
            var selected_value = $('input[name="is_multiple"]:checked').val();


            // 結果の出力
            console.log("セレクトボックスaaaa：", selected_value)

            // 選択された値ごとに選択肢の表示を切り替える
            switch (selected_value){

                case '1':
                    console.log('ラジオボタンです');

                    $('input[type="checkbox"]').each(function() {
                        var rep = $('<input type="radio">');

                        rep.attr("value", this.value);
                        rep.attr("name", this.name);
                        //rep.attr("name", "choice_set-is_correct");
                        rep.attr("id", this.id);
                        //rep.attr("id", "choice_set-0-is_correct");
                        rep.attr("class", this.class);
                        rep.attr("data-target", "fuga");
                        rep.attr("style", "display: ");

                        $(this).replaceWith(rep);
                    });

                    // 表示
                    $('.search').show();
                    $('.fas_button_parts_add').show();

                    // 非表示
                    $('.text_area').hide();

                    // disabledを付与する
                    $('.text_d').prop('disabled', true);

                    // テキストボックスの値をクリアする
                    clearTextarea();
                    //clearRadio();
                    //clearCheckbox();

                    // 回答項目の数を一つだけ残すように設定する
                    //totalManageElement_Input();







                    // input要素にreadonlyを付与する
                    //$('input.searchTerm').attr('readonly',false);
                    $('input.searchTerm').attr('disabled',false);
                    //$('input[data-target="fuga"]').attr('disabled',false);

                    // Is_correctの✓を外す
                    //$('#id_choice_set-0-is_correct').prop('checked', false)

                    $('.sb-example-1 .searchTerm').css({'border-left':'none', 'border-radius':'0 5px 5px 0', 'width':'100%', 'height':''});

                    // もともとコメントアウト
                    //画面読み込み時にラジオボタンにチェックを付ける
                    {% comment %} choice_list = []
                    // HTML内にhiddenで描画しているis_correctの値を取得してオブジェクト化
                    $('.choice_value').each(function() {
                        choice_json = {}
                        choice_json.id = $(this).data('choide_id');
                        choice_json.is_correct = $(this).data('choice_is_correct_value');
                        choice_list.push(choice_json)
                    })

                    // オブジェクトをソート(昇順)
                    let sorted_choice_list = choice_list.sort(function(a, b) {
                        return (a.id < b.id) ? -1 : 1;  //オブジェクトの昇順ソート
                    });

                    //　ループしてis_correctがTrueの場合、そのindex値で該当のselector(id)を生成してチェックする
                    sorted_choice_list.forEach((value, index , array)  => {

                        console.log("value", value)

                        if (value['is_correct'] == "True") {
                            $("#id_choice_set-" + index + "-is_correct").prop('checked', true);

                            break;// 一回trueでチェックをつけたら処理を止める
                            //return;
                        }

                    });{% endcomment %}

                    //擬似的にラジオボタンの動きを再現
                    $('input[type="radio"]').not('.form-check-input').on("input", function() {
                    //$('input[type="radio"]').on("input", function() {
                        $('input[type="radio"]').not('.form-check-input').each(function() {
                        //$('input[type="radio"]').each(function() {
                            // リセット
                            $(this).prop('checked', false);
                        })

                        $(this).prop('checked', true);
                    });


                    break;

                case '2':
                    console.log('チェックボックスです');

                    // ステップ2表示
                    $('.choice_area').show();
                    $('.fas_button_parts_add').show();

                    // 非表示
                    $('.texit_area').hide();

                    // テキストボックスの値をクリアする
                    clearTextarea();
                    //clearRadio();
                    //clearCheckbox();

                    // 回答項目の数を一つだけ残すように設定する
                    //totalManageElement_Input();





                    // input要素にreadonlyを付与する
                    //$('input.searchTerm').attr('readonly',false);
                    $('input.searchTerm').attr('disabled',false);
                    //$('input[data-target="fuga"]').attr('disabled',false);

                    $('input[type="radio"]').not('.form-check-input').each(function() {
                    //$('input[type="radio"]').each(function() {
                        var rep = $('<input type="checkbox">');

                        rep.attr("value", this.value);
                        rep.attr("name", this.name);
                        rep.attr("id", this.id);
                        rep.attr("class", this.class);
                        rep.attr("data-target", "fuga");
                        rep.attr("style", "display: ");

                        $(this).replaceWith(rep);
                    });

                    // 表示
                    $('.search').show();
                    $('.fas_button_parts_add').show();

                    // 非表示
                    $('.text_area').hide();

                    // disabledを付与する
                    $('.text_d').prop('disabled', true);

                    // Is_correctの✓を外す
                    //$('#id_choice_set-0-is_correct').prop('checked', false)

                    $('.sb-example-1 .searchTerm').css({'border-left':'none', 'border-radius':'0 5px 5px 0', 'width':'100%', 'height':''});




                    break;

                case '3':
                    console.log('記述式(完全一致)です');

                    // テキストボックスの値をクリアする
                    clearInputInfo();
                    clearRadio();
                    clearCheckbox();




                    // 回答項目の数を一つだけ残すように設定する
                    //totalManageElement_Textarea();


                    //var choice_id = $(".remove_button").attr("id");
                    //console.log("choice_id", choice_id)






                    // input要素にreadonlyを付与する
                    //$('input.searchTerm').attr('readonly',true);
                    $('input.searchTerm').attr('disabled',true);
                    //$('input[data-target="fuga"]').attr('disabled',true);



                    // 表示
                    $('.text_area').show()

                    // 非表示
                    $('.search').hide();// 正解
                    $('.fas_button_parts_add').hide();// 追加ボタン

                    // disabledを外す処理
                    $('.text_d').prop('disabled', false);

                    // Is_correctに✓をつける
                    //$('#id_choice_set-0-is_correct').prop('checked', true)

                    $('.sb-example-1 .searchTerm').css({'border-left':'2px solid #cbcbcb', 'border-radius':'5px 5px', 'width':'980px', 'height':'80px'});

                    break;

                case '4':
                    console.log('記述式(部分一致)です');

                    // テキストボックスの値をクリアする
                    clearInputInfo();
                    clearRadio();
                    clearCheckbox();




                    // 回答項目の数を一つだけ残すように設定する
                    //totalManageElement_Textarea();











                    // input要素にreadonlyを付与する
                    //$('input.searchTerm').attr('readonly',true);
                    $('input.searchTerm').attr('disabled',true);

                    //$('input[data-target="fuga"]').attr('disabled',true);



                    // 表示
                    $('.text_area').show()

                    // 非表示
                    $('.search').hide();// 正解, 削除アイコン

                    $('.fas_button_parts_add').hide();// 追加ボタン

                    // disabledを外す処理
                    $('.text_d').prop('disabled', false);

                    // Is_correctに✓をつける
                    //$('#id_choice_set-0-is_correct').prop('checked', true)

                    $('.sb-example-1 .searchTerm').css({'border-left':'2px solid #cbcbcb', 'border-radius':'5px 5px', 'width':'980px', 'height':'80px'});

                    break;

                default:
                    console.log('その他です');

            }

        });







    });

</script>


<script>
    /////////////////////////////
    // 回答項目の追加           //
    /////////////////////////////

    var add_more_flg = false;

    var choice_delete_flg = false;

    $(function(){

        var totalManageElement = $('#id_choice_set-TOTAL_FORMS');
        console.log("totalManageElement", totalManageElement)

        // 文字列を整数に変換
        var currentFileCount = parseInt(totalManageElement.val());
        console.log("currentFileCount", currentFileCount)// 1

        // 回答項目の数をカウントしてボタンをdisabledにする関数
        function countChoiceset(){

            var totalManageElement = $('#id_choice_set-TOTAL_FORMS');

            var currentFileCount = parseInt(totalManageElement.val());
            console.log("currentFileCount 1111", currentFileCount)

            //if(currentFileCount >= 5) {
            if(currentFileCount >= 7) {

                console.log("5だよ")
                $('#add_more').prop('disabled', true);
                $('#add_more').css('opacity',' 0.3');

            } else {
                //console.log("5じゃないよ")
                $('#add_more').prop('disabled', false);
                $('#add_more').css('opacity','');

            }
        }

        //$('select').on("change", function() {
        $('input[type="radio"]').change(function() {

            // セレクトボックスの値を取得
            //var selected_value = $('option:selected').val();
            //var selected_value = $(this).val();
            var selected_value = $('input[name=is_multiple]:checked').val();
            console.log("セレクトボックスの値", selected_value)

            countChoiceset();

            // 回答項目の追加ボタンが押されたときの処理
            // イベントが2回以上重複して実行されるのを防ぐ
            $('#add_more').off('click');
            $('#add_more').on('click', function(){

                console.log("クリックされた")

                // 選択項目が追加されているか検知する用のフラグ
                add_more_flg = true;
                $('#question_update_btn').prop('disabled', false);// ボタンを有効にする

                // テキスト入力欄
                var textElement = $('<input>', {
                    type: 'text',
                    name: 'choice_set-' + currentFileCount + '-text',
                    id: 'id_choice_set-' + currentFileCount + '-text',
                    class: 'searchTerm',
                    size: "110",
                    maxlength: "255",
                });

                $(textElement).attr('data-target', 'hoge');
                $(textElement).attr("placeholder", "120文字以内で入力してください。");


                // textElementをdivで囲う
                var text_obj = $('<div class="text_field">').append(textElement);


                // if文で条件を比較
                if (selected_value == '1') {

                    console.log('ラジオボタン追加');

                    // 正解
                    var checkboxElement = $('<input>', {
                        type: 'radio',
                        name: 'choice_set-' + currentFileCount + '-is_correct',
                        //name: 'example',
                        id: 'id_choice_set-' + currentFileCount + '-is_correct',
                        class: 'icon-correct',
                    });

                    // data属性追加
                    $(checkboxElement).attr('data-target', 'fuga');

                    // data属性追加
                    //$(checkboxElement).attr('data-target', 'fuga');

                    //擬似的にラジオボタンの動きを再現
                    setTimeout(function(){

                        $('input[type="radio"]').not('.form-check-input').on("input", function() {
                        //$('input[type="radio"]').on("input", function() {

                            $('input[type="radio"]').not('.form-check-input').each(function() {
                            //$('input[type="radio"]').each(function() {

                                // リセット
                                $(this).prop('checked', false);

                            })

                            $(this).prop('checked', true);
                        });

                    },1);

                } else {

                    console.log('チェックボックス追加');

                    // 正解
                    var checkboxElement = $('<input>', {
                        type: 'checkbox',
                        name: 'choice_set-' + currentFileCount + '-is_correct',
                        id: 'id_choice_set-' + currentFileCount + '-is_correct',
                        class: 'icon-correct',
                    });

                    // data属性追加
                    $(checkboxElement).attr('data-target', 'fuga');
                    $(checkboxElement).attr("placeholder", "120文字以内で入力してください。");


                }

                // 削除リンク
                var deletl_link = $('<a>', {
                    href: 'javascript:void(0);',
                    class: 'remove_button',
                    //name: 'id_choice_set-' + currentFileCount + '-text',
                });

                // 削除ボタン
                var deletl_icon = $('<i>', {
                    class: 'fas fa-minus-circle',
                    name: 'choice_set-' + currentFileCount + '-text',
                    id: 'id_choice_set-' + currentFileCount + '-text',
                });

                // deletl_iconをdeletl_linkに入れる
                var delet_a = $(deletl_link).append(deletl_icon);

                // deletl_linkをdivで囲う
                var delet_obj = $('<div class="remove_field">').append(delet_a);


                // form.id
                var formidElement = $('<input>', {
                    type: 'hidden',
                    name: 'choice_set-' + currentFileCount + '-id',
                    id: 'id_choice_set-' + currentFileCount + '-id',
                });

                // data属性追加
                $(formidElement).attr('data-target', 'form_id');



                // checkboxElementをdivで囲う
                var checkbox_obj = $('<div>').attr('class', 'searchButton').append(checkboxElement);

                // <div class="search"></div>でcheckboxとtext_objを囲う
                var choice_more = $('<div>').attr('class', 'search').append(checkbox_obj).append(text_obj).append(delet_obj).append(formidElement);

                // 項目を追加
                $('.choice_area').append(choice_more);

                // フォームの数(id_choice_set-TOTAL_FORMS, value)に追加した一行分を足す
                currentFileCount += 1;
                totalManageElement.attr('value', currentFileCount);

                countChoiceset();

                // フォームの数(id_choice_set-INITIAL_FORMS, value)から消した一行分を引く
                //INITIAL_FORMS_Count += 1;
                //total_INITIAL_FORMS.attr('value', INITIAL_FORMS_Count);

            });


        }).trigger("change");// ここで疑似的にchangeイベントを発動



        /////////////////////////////
        // 回答項目の削除　　　　    //
        /////////////////////////////

        $(document).on('click', '.remove_button', function() {

            console.log("削除します")
            $(this).parents('.search').remove();

            // 削除する項目に入力されている値を取得
            var val = $(this).parents('.search').find("input[type='text']").val();
            console.log("削除する項目のinputのvalue", val)

            var choice_id = $(this).attr("id");
            //console.log("choice_id", choice_id)

            // DBから選択したchoiceを削除する
            $.ajax({
                url: "{% url 'training:choice_delete' %}",
                type: "POST",
                data: {
                    choice_id: choice_id,
                    type: 'delete',
                },
                success: function (data) {

                    if(data.status == "ok"){
                        console.log("------- okだったよ")

                        choice_delete_flg = true;
                        $('#question_update_btn').prop('disabled', false);// ボタンを有効にする

                        //$('#id_text').attr("aria-invalid", "true");
                    }
                }
            });

            // 正解
            var fuga = $('input[data-target="fuga"]');
            //console.log("fuga1", fuga);

            // text
            var hoge = $('input[data-target="hoge"]');
            //console.log("hoge1", hoge);

            // form.id
            var form_id = $('input[data-target="form_id"]');


            // 番号振り直し(正解)
            $.each(fuga, function(i, elem){

                //console.log("fuga2", i + ': ' + elem);

                $(elem).attr('id','id_choice_set-' + (i+0) + '-is_correct');
                $(elem).attr('name','choice_set-' + (i+0) + '-is_correct');
            });

            // 番号振り直し(text)
            $.each(hoge, function(i, elem){

                //console.log("hoge2", i + ': ' + elem);

                $(elem).attr('id','id_choice_set-' + (i+0) + '-text');
                $(elem).attr('name','choice_set-' + (i+0) + '-text');
            });

            // 番号振り直し(form_id)
            $.each(form_id, function(i, elem){

                console.log("form_id", i + ': ' + elem);

                $(elem).attr('id','id_choice_set-' + (i+0) + '-id');
                $(elem).attr('name','choice_set-' + (i+0) + '-id');
            });

            // フォームの数(id_choice_set-TOTAL_FORMS, value)から消した一行分を引く
            currentFileCount -= 1;
            totalManageElement.attr('value', currentFileCount);

            countChoiceset();

            // フォームの数(id_choice_set-INITIAL_FORMS, value)から消した一行分を引く ※削除した後に値が変更できない問題解決用に追加
            if(val == null || val == '' ){
                console.log("一行分引かない");
                // 値が何も入力されていない項目を消したときは一行分引かない
            }else{
                console.log("一行分引く");
                var total_INITIAL_FORMS = $('#id_choice_set-INITIAL_FORMS');

                var INITIAL_FORMS_Count = parseInt(total_INITIAL_FORMS.val());

                INITIAL_FORMS_Count -= 1;
                total_INITIAL_FORMS.attr('value', INITIAL_FORMS_Count);

            }

        });






    });
</script>


<script>
    // -----------------
    // Dropzone.jsの設定
    // -----------------

    // Dropzoneの自動検出を無効
    Dropzone.autoDiscover = false;

    // デフォルトメッセージを変更
    //Dropzone.prototype.defaultOptions.dictRemoveFile = "取消し";

    // Get the template HTML and remove it from the doumenthe template HTML and remove it from the document
    var previewNode = document.querySelector("#template");
    // #templateというIDがあるときのみ処理
    if (previewNode) {
        previewNode.id = "";
        var previewTemplate = previewNode.parentNode.innerHTML;
        previewNode.parentNode.removeChild(previewNode);
    }

    // ページ読み込み前に事前にアップロードされたファイルをサーバ側から読み込む
    // escapejsでjsonとして受け取ることができる。受け取った情報はdist_fileというjavascript側の変数に入る
    var dist_file = "{{dist_file|escapejs}}";// ※functionの外で受け取ることに注意

    var question_pk = "{{question_pk}}";
    console.log("question_pk", question_pk)

    // json形式になっているか確認
    //console.log("------ dist_fileの形式確認 -----", dist_file)

    var currentFile = null;

    // 削除ボタンを押したときにファイルのIDを配列に追加
    var image_up_names=[];

    // アップロードに成功したファイルを配列に追加
    var file_up_max=[];

    // ファイルがアップロードされているか検知する用のフラグ
    var file_changed = false;

    // 画像
    $(function() {

        // 5秒後にエラーメッセージを消す関数
        function messageTimer(){
            $('#validation-error-poster').fadeIn("slow", function () {
                //コールバックで5秒後にフェードアウト
                $(this).delay(5000).fadeOut("slow");
            });
        }


        $("div#image_Dropzone").dropzone({// id指定

            // 設定と処理
            url: "{% url 'training:image_upload' %}",
            params: {'csrfmiddlewaretoken': getCookie('csrftoken')},
            autoProcessQueue: false,
            uploadMultiple: true,
            parallelUploads: 100,
            paramName: "file",
            maxFiles: 5,
            maxFilesize: 2000,// 2ギガ(2000)
            timeout: 7200000, // 2h //milliseconds

            acceptedFiles: 'image/*',
            dictDefaultMessage: '<i class="fas fa-file-upload fa-5x dropzone_upload_icon"></i><br /><br />ドラッグ&ドロップまたはクリック<br />アップロードできるファイルは5ファイルまでです。',
            dictMaxFilesExceeded: "アップロードできるファイルは5ファイルまでです。",
            // タイプが違う
            dictInvalidFileType: "アップロードしようとしたファイルの形式はサポートされていません。",
            // サイズが大きい
            dictFileTooBig: "アップロードしようとしたファイルのサイズが大きすぎます。",
            dictUploadCanceled: "アップロードをキャンセルしました。",
            dictCancelUploadConfirmation: "アップロードをキャンセルしますか？",
            previewTemplate: previewTemplate,
            previewsContainer: "#previews",

            // The setting up of the dropzone
            init: function() {

                var myDropzone = this;
                //console.log("myDropzone", myDropzone);

                // mockFileで表示しているファイルの削除用のフラグを立てる
                var is_uploaded_file = 0;

                // ドラッグ&ドロップ領域以外にファイルをドラッグ&ドロップしても反応しないようにする
                $(document).on('drop dragover', function (e) {
                    e.stopPropagation();
                    e.preventDefault();
                });


                // ファイルを追加したときの処理
                myDropzone.on("addedfile", function(file) {

                    console.log("ファイルが追加されました");

                    //file_changed = true;
                    //console.log("ファイルが追加された file_changed", file_changed);

                    // 配列に追加
                    //var values = $("#frmblog").serializeArray();
                    //chg_form.push({
                        //name: "dropzone",
                        //value: file
                    //});
                    //console.log("chg_form ドロップゾーン", chg_form)
                    //chg_form = jQuery.param(chg_form);

                    // アップロードに成功したファイルを配列に保存しておく
                    file_up_max.push(file.pk);
                    console.log("file_up_max addedfile 元々追加されてたファイル", file_up_max);
                    console.log("file_up_max addedfile 後から追加されたファイル", this.files.length);

                    if (file.status == "added") {
                        file_changed = true;
                        $('#question_update_btn').prop('disabled', false);// ボタンを有効にする
                    }

                    // サーバにアップしているファイルが5ファイルを超えている場合もエラー
                    //if (file_up_max.length + this.files.length >= 8) {
                    if (file_up_max.length >= 6) {

                        console.log("超えてるよ");

                        $('#validation-error-poster').html('<div class="alert alert-danger" role="alert">' + "アップロードできるファイルは5ファイルまでです。" + '</div>');

                        // エラーメッセージをフェードアウトする
                        messageTimer();

                        this.removeFile(file);

                    } else {

                        console.log("超えてないよ");

                    }

                    // ファイル名から拡張子を取得する
                    var ext = checkFileExt(file.name); // Get extension

                    // 削除ボタンを押したときにファイルのIDをimage_up_namesに追加
                    image_up_names.push(file.pk);
                    console.log('image_up_names 画像', image_up_names);


                    // ランダムな文字を生成する
                    var gendelclass = getUniqueStr()

                    // アイコンを表示するカラムのクラスをランダムに変更する。
                    $(".delete_checkbox").removeClass().addClass(gendelclass);
                    if (file.pk) {
                        console.log("ここ？");
                        // ファイルIDをセット
                        $('.' + gendelclass).removeClass().attr("value", file.pk);
                        // 親要素を削除 取り消しボタンが消えるためコメントアウト
                        //$('#previews div.preview-button.preview-text.button_colum > button').remove();
                    } else {
                        // チェックボックス要素を削除
                        $('.' + gendelclass).remove();
                    }


                    // ランダムな文字を生成する
                    var genclass = getUniqueStr()

                    // アイコンを表示するカラムのクラスをランダムに変更する。
                    $(".preview").removeClass().addClass(genclass);


                    switch (ext) {
                        // エクセル系
                        case 'xls':
                        case 'xlsx':
                            $('.' + genclass).addClass("icon xls");
                            $('.' + genclass).append('<i class="far fa-file-excel"></i>');
                            break;

                        // ワード系
                        case 'doc':
                        case 'docx':
                            $('.' + genclass).addClass("icon doc");
                            $('.' + genclass).append('<i class="far fa-file-word"></i>');
                            break;

                        // パワーポイント系
                        case 'ppt':
                        case 'pptx':
                            $('.' + genclass).addClass("icon ppt");
                            $('.' + genclass).append('<i class="far fa-file-powerpoint"></i>');
                            break;

                        // 写真系
                        case 'png':
                        case 'jpg':
                        case 'jpeg':
                        case 'svg':
                        case 'gif':
                        case 'tiff':
                        case 'bmp':
                            $('.' + genclass).addClass("icon img");
                            $('.' + genclass).append('<i class="far fa-file-image"></i>');
                            break;

                        // 音声系
                        case 'mp3':
                        case 'wma':
                        case 'aac':
                        case 'ogg':
                        case 'mov':
                        case 'm4a':
                        case 'mkv':
                        case 'flac':
                        case 'wav':
                        case 'aif':
                            $('.' + genclass).addClass("icon audio");
                            $('.' + genclass).append('<i class="far fa-file-audio"></i>');
                            break;

                        // 動画系
                        case 'mp4':
                        case 'mov':
                        case 'mpg':
                        case 'mpeg':
                        case 'avi':
                        case 'wmv':
                        case 'webm':
                        case 'flv':
                        case 'mkv':
                            $('.' + genclass).addClass("icon vido");
                            $('.' + genclass).append('<i class="far fa-file-video"></i>');
                            break;

                        // アーカイブ系
                        case 'zip':
                        case 'lzh':
                        case 'cab':
                        case 'tar':
                        case 'gz':
                        case 'tgz':
                            $('.' + genclass).addClass("icon arc");
                            $('.' + genclass).append('<i class="far fa-file-archive"></i>');
                            break;

                        // PDF
                        case 'pdf':
                            $('.' + genclass).addClass("icon pdf");
                            $('.' + genclass).append('<i class="far fa-file-pdf"></i>');
                            break;

                        // その他
                        default:
                            $('.' + genclass).addClass("icon");
                            $('.' + genclass).append('<i class="far fa-file"></i>');
                            break;
                        }

                        // 追加フラグをたてる
                        if (this.files.length > 0) {
                            addflug = true;
                        } else {
                            addflug = false;
                        }



                }); // end addfile event



                // 確定ボタンを押下したらファイルをアップロード
                $("#question_update_btn").click(function (e) {

                    //if (addflug) {
                    if (myDropzone.files.length > 0) {
                        // フラグがtrueの時はファイルアップロードを実行
                        e.preventDefault();
                        // キューを実行、ファイルアップデートviewで処理が行われる
                        myDropzone.processQueue();

                    } else {
                        // フラグがfalseの時はメッセージ等の保存を実行
                        document.myform.submit();
                        window.opener.focus();
                    }
                });

                // サーバ上にあるファイルを描画する。
                // StringとなっているのでJSONに変換
                // dist_fileはHTMLのScriptタグで取得（Viewのコンテキストとして取得）
                //if (dist_file.length !== 0) {
                if (dist_file) {

                    //file_changed = true;

                    // js側でjson形式に加工する
                    dist_file_json = JSON.parse(dist_file);
                    console.log("---- dist_file_json 画像 ----", dist_file_json)

                    // dist_file_jsonをループで取り出す
                    for (var i = 0; i < dist_file_json.length; i++) {

                        // サーバー側にあるアップロードされた情報のファイルの元ネタを作成
                        var mockFile = { name: dist_file_json[i].fields.name, size: dist_file_json[i].fields.size, pk:dist_file_json[i].pk};
                        console.log("---- mockFile 動画 ----", mockFile)

                        // mockFileを使ってaddfileイベントを発火し拡張子等のチェックを行う。
                        // ユーザーがDropzoneのドラッグ＆ドロップの領域に対してドラッグ＆ドロップしたときと同じ処理が走るイメージ
                        myDropzone.emit("addedfile", mockFile);

                        // thumbnailイベントを発火しパスの情報を紐付ける
                        myDropzone.emit("thumbnail", mockFile, dist_file_json[i].fields.file);

                    }
                }

            }, //end init


            // 上限数を超えたときに行われる処理
            maxfilesexceeded:  function(file, errormessage, xhr) {

                // 上限数を超えたファイルは削除する
                console.log("maxfilesexceededが動いてるよ");

                // エラーメッセージ
                $('#validation-error-poster').html('<div class="alert alert-danger" role="alert">' + response + '</div>');

                messageTimer();

                this.removeFile(file);

            },
            // アップロード成功時の処理
            successmultiple: function(file, response){

                console.log("successmultipleが動いてるよ");

                $('#question_update_form').submit();

                window.opener.focus();

            },
            // アップロード失敗時にメッセージを表示する。
            error: function(file, response, xhr){

                //　動画ファイルのサイズが大きいメッセージを出す
                //$('#validation-error-poster').html('<div class="alert alert-danger" role="alert">' + response + '</div>');

                //messageTimer();

                // フロントエンドでエラーが発生した場合。(サーバからのレスポンスがないエラー)
                if (xhr == null) {

                    console.log("ファイルのタイプが違う error");

                    // エラーメッセージ(ファイルの上限を超えた場合)
                    $('#validation-error-poster').html('<div class="alert alert-danger" role="alert">' + response + '</div>');//　動画ファイルのタイプが違うメッセージを出す

                    messageTimer();

                    // アップロードされたファイルを削除する
                    this.removeFile(file);


                // サーバーからレスポンスが帰ってきた場合(サーバ側でエラーが発生した場合)
                } else {

                    $('#validation-error-poster').html('<div class="alert alert-danger" role="alert">' + xhr.statusText + '</div>');

                    messageTimer();

                }
            },

            removedfile:function(file){

                // 削除ボタンを押下した場合、Ajaxで送信
                console.log("削除ボタンを押しました")
                //chg_form.pop();
                //console.log("chg_form 削除", chg_form);

                var ref;
                (ref = file.previewElement) != null ? ref.parentNode.removeChild(file.previewElement) : void 0;

                //console.log('image_up_names', image_up_names);

                file_changed = true;
                $('#question_update_btn').prop('disabled', false);// ボタンを有効にする

                $.ajax({
                    url: "{% url 'training:image_delete' %}", //your php file path to remove specified image
                    type: "POST",
                    data: {
                        //image_up_name: image_up_names[i],
                        image_up_name: file.pk,
                        question_pk: question_pk,
                        type: 'delete',
                    },
                });

                var image = image_up_names.pop();
                console.log('image_up_names 削除後', image_up_names);

                var file = file_up_max.pop();
                console.log('file_up_max 削除後', file_up_max);

                //if(image_up_names.length === 0) {
                    //console.log("ないよ")
                    //file_changed = false;

                    //console.log("ないよ file_changed", file_changed)

                //}else{
                    //console.log("あるよ")
                    //file_changed = true;

                    //console.log("あるよ file_changed", file_changed)
                //}

            }
        });


        Dropzone.options.myAwesomeDropzone = {

            accept: function(file, done) {
                console.log("uploaded");
                done();
            },

            addRemoveLinks: true,

            init: function() {
            this.on("addedfile", function() {
                if (this.files[1]!=null){
                    console.log("ポスター、ifに落ちたよ");
                    this.removeFile(this.files[0]);
                }
            });
            }
        };

        // ファイルの拡張子を取得する。
        function checkFileExt(filename){
            filename = filename.toLowerCase();
            return filename.split('.').pop();
        }

        // ランダムな値を生成
        function getUniqueStr(myStrong){
            var strong = 1000;
            if (myStrong) strong = myStrong;
            return new Date().getTime().toString(16) + Math.floor(strong*Math.random()).toString(16)
        }
    });
</script>








{% endblock %}